<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite RTS - Global Warfare</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Rajdhani', sans-serif; 
      background: radial-gradient(ellipse at bottom, #0d1b2a 0%, #000000 100%);
      overflow: hidden; 
      color: #fff;
    }
    
    .orbitron { font-family: 'Orbitron', sans-serif; }
    
    /* Animated Background */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle 3s infinite;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    
    /* Glass Morphism */
    .glass {
      background: rgba(13, 27, 42, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(100, 200, 255, 0.2);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .glass-bright {
      background: rgba(30, 58, 90, 0.7);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(100, 200, 255, 0.4);
      box-shadow: 
        0 8px 40px rgba(59, 130, 246, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    /* Neon Button */
    .btn-neon {
      position: relative;
      padding: 0.8rem 2rem;
      font-size: 1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 
        0 0 20px rgba(102, 126, 234, 0.5),
        0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn-neon:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 0 40px rgba(102, 126, 234, 0.8),
        0 10px 25px rgba(0, 0, 0, 0.4);
    }
    
    .btn-neon:active {
      transform: translateY(-1px);
    }
    
    .btn-cyan {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      box-shadow: 
        0 0 20px rgba(6, 182, 212, 0.5),
        0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn-cyan:hover {
      box-shadow: 
        0 0 40px rgba(6, 182, 212, 0.8),
        0 10px 25px rgba(0, 0, 0, 0.4);
    }
    
    .btn-red {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 
        0 0 20px rgba(239, 68, 68, 0.5),
        0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn-red:hover {
      box-shadow: 
        0 0 40px rgba(239, 68, 68, 0.8),
        0 10px 25px rgba(0, 0, 0, 0.4);
    }
    
    /* Resource Badge */
    .resource-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      background: linear-gradient(135deg, rgba(30, 58, 90, 0.9), rgba(13, 27, 42, 0.9));
      border: 1px solid rgba(100, 200, 255, 0.3);
      border-radius: 20px;
      font-size: 1.1rem;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .resource-badge:hover {
      transform: scale(1.05);
      border-color: rgba(100, 200, 255, 0.6);
    }
    
    /* Map */
    #map { 
      width: 100%; 
      height: 100%; 
      background: #0a0e1a;
      filter: brightness(0.9) contrast(1.1);
    }
    
    /* Unit Marker */
    .unit-marker {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 3px solid;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .unit-marker::before {
      content: '';
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .unit-marker:hover::before {
      opacity: 0.2;
      animation: pulse-ring 1.5s infinite;
    }
    
    .unit-marker.selected {
      animation: selected-pulse 1s infinite;
      border-width: 4px;
      box-shadow: 0 0 20px currentColor;
    }
    
    @keyframes selected-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 0.3; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    
    /* Building Marker */
    .building-marker {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      border: 3px solid;
      background: rgba(0, 0, 0, 0.7);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }
    
    .building-marker:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px currentColor;
    }
    
    /* Range Circle */
    .range-indicator {
      stroke-width: 2;
      stroke-dasharray: 10, 5;
      fill: none;
      opacity: 0.6;
      animation: rotate-dash 20s linear infinite;
    }
    
    @keyframes rotate-dash {
      to { stroke-dashoffset: -1000; }
    }
    
    /* Combat Log */
    .combat-log-entry {
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.2), transparent);
      border-left: 3px solid #ef4444;
      border-radius: 4px;
      font-size: 0.9rem;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateX(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateX(0); 
      }
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
      from { 
        opacity: 0; 
        transform: scale(0.9); 
      }
      to { 
        opacity: 1; 
        transform: scale(1); 
      }
    }
    
    /* Input */
    .input-neon {
      width: 100%;
      padding: 1rem 1.5rem;
      background: rgba(13, 27, 42, 0.8);
      border: 2px solid rgba(100, 200, 255, 0.3);
      border-radius: 12px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      outline: none;
    }
    
    .input-neon:focus {
      border-color: #06b6d4;
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
    }
    
    .input-neon::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    /* Panel */
    .side-panel {
      width: 320px;
      background: rgba(13, 27, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(100, 200, 255, 0.2);
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
    }
    
    /* Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(13, 27, 42, 0.5);
      border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #667eea, #764ba2);
      border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #764ba2, #667eea);
    }
    
    /* Hidden */
    .hidden { display: none !important; }
    
    /* Glow Effect */
    .glow {
      text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
    }
    
    /* Title */
    .game-title {
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea 0%, #06b6d4 50%, #764ba2 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 40px rgba(102, 126, 234, 0.5);
      letter-spacing: 4px;
      animation: glow-pulse 3s ease-in-out infinite;
    }
    
    @keyframes glow-pulse {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    
    /* Beam Effect */
    .beam-line {
      stroke-linecap: round;
      filter: drop-shadow(0 0 8px currentColor);
    }
  </style>
</head>
<body>

<!-- Animated Stars Background -->
<div class="stars" id="starsContainer"></div>

<!-- ============================================ -->
<!-- VIEW A: LOGIN -->
<!-- ============================================ -->
<div id="viewA" data-view="A" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="glass-bright rounded-3xl p-12 max-w-xl w-full mx-4 text-center">
    <h1 class="game-title orbitron mb-4">ELITE RTS</h1>
    <p class="text-xl text-cyan-300 mb-8 font-semibold">Global Tactical Warfare</p>
    
    <input 
      id="nickInput" 
      type="text" 
      placeholder="Komutan AdÄ±nÄ±z"
      class="input-neon mb-6"
    />
    
    <button id="loginBtn" class="btn-neon btn-cyan orbitron w-full text-lg py-4">
      âš¡ SAVAÅA HAZIR
    </button>
    
    <p class="text-xs text-slate-400 mt-6 opacity-60">
      Firebase Realtime Multiplayer
    </p>
  </div>
</div>

<!-- ============================================ -->
<!-- VIEW B: LOBBY -->
<!-- ============================================ -->
<div id="viewB" data-view="B" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="glass-bright rounded-3xl p-10 max-w-3xl w-full mx-4">
    <h2 class="text-4xl font-black orbitron text-cyan-400 mb-8 glow text-center">
      ğŸ® KOMUTA MERKEZÄ°
    </h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <button id="createRoomBtn" class="btn-neon orbitron text-lg py-6">
        â• YENÄ° OPERASYON BAÅLAT
      </button>
      
      <button id="joinRoomBtn" class="btn-neon btn-cyan orbitron text-lg py-6">
        ğŸšª OPERASYONA KATIL
      </button>
    </div>
    
    <div id="joinRoomPanel" class="hidden">
      <input 
        id="roomIdInput" 
        type="text" 
        placeholder="Operasyon Kodu"
        class="input-neon mb-4"
      />
      <button id="joinRoomConfirmBtn" class="btn-neon btn-cyan orbitron w-full py-3">
        BAÄLAN
      </button>
    </div>
    
    <div class="text-center mt-6">
      <p class="text-sm text-slate-300">
        Komutan: <span id="userNickDisplay" class="text-cyan-400 font-bold text-lg"></span>
      </p>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- VIEW C: ROOM -->
<!-- ============================================ -->
<div id="viewC" data-view="C" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="glass-bright rounded-3xl p-10 max-w-3xl w-full mx-4">
    <h2 class="text-3xl font-black orbitron text-cyan-400 mb-4 glow text-center">
      ğŸ  OPERASYON ODASI
    </h2>
    <p class="text-center text-lg mb-8">
      Kod: <span id="roomIdDisplay" class="text-cyan-300 font-mono font-black text-2xl tracking-widest"></span>
    </p>
    
    <div id="playersListInRoom" class="mb-8 space-y-4">
      <!-- Dynamic players -->
    </div>
    
    <div class="flex gap-4">
      <button id="readyToggleBtn" class="btn-neon flex-1 py-4">
        âœ“ HAZIR
      </button>
      
      <button id="startGameBtn" class="btn-neon btn-cyan flex-1 py-4 hidden">
        ğŸš€ OPERASYON BAÅLAT
      </button>
      
      <button id="leaveRoomBtn" class="btn-neon btn-red py-4 px-8">
        â† Ã‡IKIÅ
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- VIEW D: GAME -->
<!-- ============================================ -->
<div id="viewD" data-view="D" class="hidden fixed inset-0 flex flex-col">
  
  <!-- TOP BAR -->
  <div class="glass-bright p-4 flex items-center justify-between gap-4 z-20 border-b border-cyan-500/30">
    <div class="flex items-center gap-3 flex-wrap">
      <div class="resource-badge">
        <span class="text-2xl">ğŸ’°</span>
        <span id="resMoney" class="text-xl">300</span>
      </div>
      <div class="resource-badge">
        <span class="text-2xl">ğŸ›¢ï¸</span>
        <span id="resOil" class="text-xl">120</span>
      </div>
      <div class="resource-badge">
        <span class="text-2xl">â›“ï¸</span>
        <span id="resIron" class="text-xl">120</span>
      </div>
      <div class="resource-badge">
        <span class="text-2xl">ğŸª™</span>
        <span id="resGold" class="text-xl">10</span>
      </div>
      <div class="resource-badge">
        <span class="text-2xl">ğŸ‘¥</span>
        <span id="resPop" class="text-xl">0</span>/<span id="resPopMax" class="text-lg">200</span>
      </div>
    </div>
    
    <div class="flex items-center gap-3">
      <button id="helpBtn" class="btn-neon btn-cyan text-sm px-4 py-2">â“ YARDIM</button>
      <button id="leaveGameBtn" class="btn-neon btn-red text-sm px-4 py-2">ğŸšª Ã‡IKIÅ</button>
    </div>
  </div>
  
  <!-- MAIN GAME AREA -->
  <div class="flex-1 flex relative overflow-hidden">
    
    <!-- LEFT PANEL -->
    <div class="side-panel p-6 overflow-y-auto custom-scrollbar z-10">
      <h3 class="text-2xl font-black orbitron text-cyan-400 mb-4 glow">
        ğŸ—ï¸ Ä°NÅA & ÃœRETÄ°M
      </h3>
      
      <button id="toggleBuildBtn" class="btn-neon w-full mb-4 py-3">
        Ä°NÅAAT MENÃœSÃœ
      </button>
      
      <div id="buildMenu" class="hidden space-y-2 mb-6">
        <!-- Dynamic build menu -->
      </div>
      
      <button id="toggleProduceBtn" class="btn-neon btn-cyan w-full mb-4 py-3">
        BÄ°RÄ°M ÃœRETÄ°MÄ°
      </button>
      
      <div id="produceMenu" class="hidden space-y-2">
        <p class="text-sm text-slate-400 text-center">Bir bina seÃ§in</p>
      </div>
    </div>
    
    <!-- MAP -->
    <div class="flex-1 relative">
      <div id="map"></div>
    </div>
    
    <!-- RIGHT PANEL -->
    <div class="side-panel p-6 overflow-y-auto custom-scrollbar z-10">
      <h3 class="text-2xl font-black orbitron text-cyan-400 mb-4 glow">
        ğŸ“Š TAKTÄ°K BÄ°LGÄ°
      </h3>
      
      <div class="mb-6">
        <h4 class="text-lg font-bold text-cyan-300 mb-3">SeÃ§ili Birimler</h4>
        <div id="selectedUnitsInfo" class="text-sm text-slate-300 space-y-2">
          <p class="text-slate-500">Birim seÃ§ilmedi</p>
        </div>
      </div>
      
      <div class="mb-6">
        <h4 class="text-lg font-bold text-cyan-300 mb-3">Ãœretim KuyruÄŸu</h4>
        <div id="productionQueue" class="text-sm text-slate-300 space-y-2">
          <p class="text-slate-500">Kuyruk boÅŸ</p>
        </div>
      </div>
      
      <div>
        <h4 class="text-lg font-bold text-red-400 mb-3">âš”ï¸ SavaÅŸ GÃ¼nlÃ¼ÄŸÃ¼</h4>
        <div id="combatLog" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
          <!-- Dynamic log -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- BOTTOM HINT -->
  <div class="glass-bright p-3 text-center text-sm font-semibold text-cyan-300 z-10 border-t border-cyan-500/30">
    <span id="hintText">ğŸ¯ Sol tÄ±k: SeÃ§ | Tekrar tÄ±k: Hareket | Birim otomatik saldÄ±rÄ±r</span>
  </div>
</div>

<!-- ============================================ -->
<!-- HELP MODAL -->
<!-- ============================================ -->
<div id="helpModal" class="hidden modal-overlay">
  <div class="modal-content glass-bright rounded-3xl p-8 max-w-2xl">
    <h2 class="text-3xl font-black orbitron text-cyan-400 mb-6 glow text-center">
      ğŸ“– TAKTÄ°K REHBER
    </h2>
    
    <div class="space-y-4 text-lg">
      <div class="flex items-start gap-3">
        <span class="text-cyan-400 font-black">ğŸ¯</span>
        <div>
          <strong class="text-cyan-300">Sol TÄ±k:</strong> 
          <span class="text-slate-300">Birim/bina seÃ§</span>
        </div>
      </div>
      
      <div class="flex items-start gap-3">
        <span class="text-cyan-400 font-black">ğŸ¯</span>
        <div>
          <strong class="text-cyan-300">Tekrar TÄ±k:</strong> 
          <span class="text-slate-300">SeÃ§ili birim hedefe hareket eder</span>
        </div>
      </div>
      
      <div class="flex items-start gap-3">
        <span class="text-cyan-400 font-black">âš”ï¸</span>
        <div>
          <strong class="text-cyan-300">Otomatik SaldÄ±rÄ±:</strong> 
          <span class="text-slate-300">DÃ¼ÅŸman menzile girerse otomatik ateÅŸ edilir</span>
        </div>
      </div>
      
      <div class="flex items-start gap-3">
        <span class="text-cyan-400 font-black">ğŸ¯</span>
        <div>
          <strong class="text-cyan-300">Menzil GÃ¶sterimi:</strong> 
          <span class="text-slate-300">Birime tÄ±klayÄ±nca menzil halkasÄ± gÃ¶rÃ¼nÃ¼r</span>
        </div>
      </div>
    </div>
    
    <div class="mt-8 p-4 glass rounded-xl border border-red-500/50">
      <p class="text-center text-lg font-bold text-red-400">
        ğŸ¯ HEDEF: DÃ¼ÅŸman Merkez Ãœs'Ã¼nÃ¼ Yok Et!
      </p>
    </div>
    
    <button id="closeHelpBtn" class="btn-neon btn-cyan orbitron w-full mt-8 py-4">
      ANLADIM
    </button>
  </div>
</div>

<!-- ============================================ -->
<!-- RESULT MODAL -->
<!-- ============================================ -->
<div id="resultModal" class="hidden modal-overlay">
  <div class="modal-content glass-bright rounded-3xl p-12 text-center max-w-lg">
    <h2 id="resultTitle" class="text-5xl font-black orbitron mb-6 glow">ğŸ†</h2>
    <p id="resultText" class="text-2xl text-slate-200 mb-8 font-semibold"></p>
    <button id="closeResultBtn" class="btn-neon btn-cyan orbitron w-full py-4 text-lg">
      KOMUTA MERKEZÄ°NE DÃ–N
    </button>
  </div>
</div>

<!-- ============================================ -->
<!-- SCRIPTS -->
<!-- ============================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ============================================
// ANIMATED BACKGROUND
// ============================================
function createStars() {
  const container = document.getElementById('starsContainer');
  for (let i = 0; i < 100; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    star.style.animationDelay = Math.random() * 3 + 's';
    container.appendChild(star);
  }
}
createStars();

// ============================================
// FIREBASE CONFIG
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyCV609XeHMtmZtD3FZDJ0cQnDiXke4YlUs",
  authDomain: "globalrts-ea3b4.firebaseapp.com",
  databaseURL: "https://globalrts-ea3b4-default-rtdb.firebaseio.com",
  projectId: "globalrts-ea3b4",
  storageBucket: "globalrts-ea3b4.firebasestorage.app",
  messagingSenderId: "404807030737",
  appId: "1:404807030737:web:2efecfef884db0b58632f0",
  measurementId: "G-Q5YKGP8EXR"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ============================================
// GLOBAL STATE
// ============================================
const state = {
  currentView: 'A',
  uid: null,
  nick: null,
  roomId: null,
  isHost: false,
  gameStarted: false,
  
  tick: 0,
  entities: new Map(),
  selectedId: null,
  myTeam: null,
  
  resources: {
    money: 300,
    oil: 120,
    iron: 120,
    gold: 10,
    pop: 0,
    popMax: 200
  },
  
  commandBuffer: [],
  lastSimTime: 0,
  simulationRunning: false,
  
  map: null,
  mapReady: false,
  rangeCircle: null,
  
  combatLog: [],
  
  seed: 12345,
  rng: null
};

// ============================================
// CONSTANTS
// ============================================
const WORLD_SCALE = 100; // 1 px = 100m
const NET_TICK_RATE = 10;
const NET_DT = 1 / NET_TICK_RATE;
const INPUT_DELAY = 3;

// GERÃ‡EK MENZÄ°LLER (metre)
const UNIT_TYPES = {
  Infantry: { 
    hp: 100, speed: 1.4, range: 400, dps: 8, fireRate: 5, 
    icon: 'ğŸª–', cost: { money: 40 }, buildTime: 5,
    name: 'Piyade'
  },
  MG: { 
    hp: 120, speed: 1.2, range: 600, dps: 15, fireRate: 8, 
    icon: 'âš”ï¸', cost: { money: 60 }, buildTime: 6,
    name: 'AÄŸÄ±r Silah'
  },
  Sniper: { 
    hp: 80, speed: 1.3, range: 1200, dps: 35, fireRate: 0.8, 
    icon: 'ğŸ¯', cost: { money: 90, iron: 10 }, buildTime: 8,
    name: 'Keskin NiÅŸancÄ±'
  },
  AT: { 
    hp: 100, speed: 1.2, range: 1500, dps: 50, fireRate: 0.4, 
    icon: 'ğŸš€', cost: { money: 120, iron: 20 }, buildTime: 10,
    name: 'Tanksavar'
  },
  APC: { 
    hp: 350, speed: 15, range: 800, dps: 12, fireRate: 4, 
    icon: 'ğŸš', cost: { money: 180, oil: 40, iron: 40 }, buildTime: 12,
    name: 'ZÄ±rhlÄ± AraÃ§'
  },
  Tank: { 
    hp: 600, speed: 12, range: 2500, dps: 60, fireRate: 0.3, 
    icon: 'ğŸ›¡ï¸', cost: { money: 300, oil: 100, iron: 150 }, buildTime: 20,
    name: 'Ana Muharebe TankÄ±'
  },
  Artillery: { 
    hp: 250, speed: 8, range: 8000, dps: 45, fireRate: 0.2, 
    icon: 'ğŸ’£', cost: { money: 280, oil: 80, iron: 120 }, buildTime: 18,
    name: 'TopÃ§u'
  },
  MLRS: { 
    hp: 300, speed: 10, range: 12000, dps: 40, fireRate: 0.15, 
    icon: 'ğŸ’¥', cost: { money: 350, oil: 100, iron: 140 }, buildTime: 22,
    name: 'Ã‡ok Namlulu Roketatar'
  },
  Helicopter: { 
    hp: 200, speed: 35, range: 3000, dps: 25, fireRate: 2, 
    icon: 'ğŸš', cost: { money: 320, oil: 120 }, buildTime: 18,
    name: 'SaldÄ±rÄ± Helikopteri'
  },
  Drone: { 
    hp: 150, speed: 28, range: 5000, dps: 18, fireRate: 1.5, 
    icon: 'âœˆï¸', cost: { money: 250, oil: 80 }, buildTime: 15,
    name: 'SilahlÄ± Ä°HA'
  }
};

const BUILDING_TYPES = {
  HQ: { 
    hp: 1200, icon: 'ğŸ›ï¸', produces: ['Infantry'], 
    cost: { money: 0 }, buildTime: 0,
    name: 'Merkez Ãœs'
  },
  Barracks: { 
    hp: 600, icon: 'ğŸ°', produces: ['Infantry', 'MG', 'Sniper', 'AT'], 
    cost: { money: 150 }, buildTime: 20,
    name: 'KÄ±ÅŸla'
  },
  Factory: { 
    hp: 700, icon: 'ğŸ­', produces: ['APC', 'Tank'], 
    cost: { money: 250, oil: 50, iron: 50 }, buildTime: 30,
    name: 'Tank FabrikasÄ±'
  },
  Artillery_Base: { 
    hp: 650, icon: 'ğŸ”§', produces: ['Artillery', 'MLRS'], 
    cost: { money: 280, iron: 80 }, buildTime: 28,
    name: 'TopÃ§u ÃœssÃ¼'
  },
  Airfield: { 
    hp: 800, icon: 'ğŸ›«', produces: ['Helicopter', 'Drone'], 
    cost: { money: 400, oil: 100 }, buildTime: 35,
    name: 'Hava ÃœssÃ¼'
  },
  Refinery: { 
    hp: 500, icon: 'ğŸ›¢ï¸', income: { oil: 3 }, 
    cost: { money: 180 }, buildTime: 25,
    name: 'Rafineri'
  },
  Mine: { 
    hp: 550, icon: 'â›“ï¸', income: { iron: 3 }, 
    cost: { money: 200 }, buildTime: 28,
    name: 'Maden'
  },
  Bank: { 
    hp: 450, icon: 'ğŸ¦', income: { money: 10 }, 
    cost: { money: 150 }, buildTime: 20,
    name: 'Ekonomi Merkezi'
  }
};

const INCOME_TICKS = 30; // 3 saniye

// ============================================
// RNG
// ============================================
class SeededRandom {
  constructor(seed) {
    this.seed = seed;
  }
  
  next() {
    this.seed = (this.seed * 9301 + 49297) % 233280;
    return this.seed / 233280;
  }
  
  range(min, max) {
    return min + this.next() * (max - min);
  }
}

// ============================================
// ENTITY CLASSES
// ============================================
class Entity {
  constructor(id, type, team, lat, lng) {
    this.id = id;
    this.type = type;
    this.team = team;
    this.lat = lat;
    this.lng = lng;
    this.marker = null;
  }
  
  destroy() {
    if (this.marker) {
      state.map.removeLayer(this.marker);
      this.marker = null;
    }
    if (state.selectedId === this.id) {
      state.selectedId = null;
      updateSelection();
    }
  }
}

class Unit extends Entity {
  constructor(id, type, team, lat, lng, stats) {
    super(id, type, team, lat, lng);
    this.stats = { ...stats };
    this.hp = stats.hp;
    this.targetPos = null;
    this.targetEnemy = null;
    this.cooldown = 0;
  }
  
  update(dt) {
    if (this.cooldown > 0) {
      this.cooldown -= dt;
    }
    
    // DÃ¼ÅŸman tarama (otomatik saldÄ±rÄ±)
    if (!this.targetEnemy && this.stats.range > 0) {
      this.scanForEnemies();
    }
    
    // DÃ¼ÅŸmana saldÄ±r
    if (this.targetEnemy) {
      const enemy = state.entities.get(this.targetEnemy);
      if (enemy && enemy.hp > 0) {
        const dx = enemy.lng - this.lng;
        const dy = enemy.lat - this.lat;
        const dist = Math.sqrt(dx*dx + dy*dy) * WORLD_SCALE;
        
        if (dist <= this.stats.range) {
          // Menzil iÃ§inde - ateÅŸ et
          if (this.cooldown <= 0) {
            const damage = this.stats.dps / this.stats.fireRate;
            enemy.hp -= damage;
            this.cooldown = 1 / this.stats.fireRate;
            
            drawBeam(this.lat, this.lng, enemy.lat, enemy.lng);
            
            if (enemy.hp <= 0) {
              addCombatLog(`${this.stats.name} bir ${enemy.stats.name} imha etti!`);
              destroyEntity(enemy.id);
              
              if (enemy.type === 'HQ') {
                endGame(this.team);
              }
            }
          }
        } else {
          // Menzil dÄ±ÅŸÄ±nda - yaklaÅŸ
          const speed = this.stats.speed / WORLD_SCALE * dt;
          const ratio = Math.min(1, speed / (dist / WORLD_SCALE));
          this.lng += dx * ratio;
          this.lat += dy * ratio;
        }
      } else {
        this.targetEnemy = null;
      }
    }
    
    // Normal hareket (dÃ¼ÅŸman yoksa)
    if (!this.targetEnemy && this.targetPos) {
      const dx = this.targetPos.lng - this.lng;
      const dy = this.targetPos.lat - this.lat;
      const dist = Math.sqrt(dx*dx + dy*dy);
      
      if (dist > 0.0001) {
        const speed = this.stats.speed / WORLD_SCALE * dt;
        const ratio = Math.min(1, speed / dist);
        this.lng += dx * ratio;
        this.lat += dy * ratio;
      } else {
        this.targetPos = null;
      }
    }
  }
  
  scanForEnemies() {
    const maxRange = (this.stats.range + 100) / WORLD_SCALE;
    let closest = null;
    let closestDist = Infinity;
    
    state.entities.forEach(e => {
      if (e.team !== this.team && e.hp > 0) {
        const dx = e.lng - this.lng;
        const dy = e.lat - this.lat;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        if (dist < maxRange && dist < closestDist) {
          closest = e.id;
          closestDist = dist;
        }
      }
    });
    
    if (closest) {
      this.targetEnemy = closest;
      this.targetPos = null;
    }
  }
  
  createMarker() {
    const color = this.team === 'p1' ? '#06b6d4' : '#ef4444';
    const icon = L.divIcon({
      className: '',
      html: `<div class="unit-marker" style="background:${color}20; border-color:${color}; color:${color};">${this.stats.icon}</div>`,
      iconSize: [32, 32]
    });
    
    this.marker = L.marker([this.lat, this.lng], { icon });
    this.marker.entityId = this.id;
    this.marker.addTo(state.map);
    
    this.marker.on('click', (e) => {
      L.DomEvent.stopPropagation(e);
      handleUnitClick(this.id);
    });
  }
  
  updateMarkerPosition() {
    if (this.marker) {
      this.marker.setLatLng([this.lat, this.lng]);
    }
  }
}

class Building extends Entity {
  constructor(id, type, team, lat, lng, stats) {
    super(id, type, team, lat, lng);
    this.stats = { ...stats };
    this.hp = stats.hp;
    this.productionQueue = [];
  }
  
  update(dt) {
    // Gelir
    if (this.stats.income && state.tick % INCOME_TICKS === 0) {
      if (this.team === state.myTeam) {
        Object.entries(this.stats.income).forEach(([res, val]) => {
          state.resources[res] = (state.resources[res] || 0) + val;
        });
      }
    }
    
    // Ãœretim
    if (this.productionQueue.length > 0) {
      const item = this.productionQueue[0];
      item.progress += dt;
      
      if (item.progress >= item.time) {
        this.productionQueue.shift();
        
        if (this.team === state.myTeam) {
          spawnUnit(item.unitType, this.team, this.lat + 0.002, this.lng + 0.002);
          addCombatLog(`${UNIT_TYPES[item.unitType].name} savaÅŸa hazÄ±r!`);
        }
      }
    }
  }
  
  createMarker() {
    const color = this.team === 'p1' ? '#06b6d4' : '#ef4444';
    const icon = L.divIcon({
      className: '',
      html: `<div class="building-marker" style="border-color:${color}; color:${color};">${this.stats.icon}</div>`,
      iconSize: [48, 48]
    });
    
    this.marker = L.marker([this.lat, this.lng], { icon });
    this.marker.entityId = this.id;
    this.marker.addTo(state.map);
    
    this.marker.on('click', (e) => {
      L.DomEvent.stopPropagation(e);
      handleBuildingClick(this.id);
    });
  }
  
  updateMarkerPosition() {
    // Buildings don't move
  }
}

// ============================================
// ENTITY MANAGEMENT
// ============================================
function spawnUnit(type, team, lat, lng) {
  const id = `u_${Date.now()}_${Math.random()}`;
  const stats = UNIT_TYPES[type];
  const unit = new Unit(id, type, team, lat, lng, stats);
  state.entities.set(id, unit);
  
  if (state.mapReady) {
    unit.createMarker();
  }
  
  if (team === state.myTeam) {
    state.resources.pop++;
  }
  
  return unit;
}

function createBuilding(type, team, lat, lng) {
  const id = `b_${Date.now()}_${Math.random()}`;
  const stats = BUILDING_TYPES[type];
  const building = new Building(id, type, team, lat, lng, stats);
  state.entities.set(id, building);
  
  if (state.mapReady) {
    building.createMarker();
  }
  
  return building;
}

function destroyEntity(id) {
  const entity = state.entities.get(id);
  if (entity) {
    entity.destroy();
    state.entities.delete(id);
    
    if (entity instanceof Unit && entity.team === state.myTeam) {
      state.resources.pop = Math.max(0, state.resources.pop - 1);
    }
  }
}

// ============================================
// CLICK HANDLERS
// ============================================
function handleUnitClick(unitId) {
  const unit = state.entities.get(unitId);
  if (!unit || unit.team !== state.myTeam) return;
  
  if (state.selectedId === unitId) {
    // Zaten seÃ§ili - hareket komutu iÃ§in bekle
    document.getElementById('hintText').textContent = 'ğŸ“ Hedefe tÄ±klayÄ±n - Birim hareket edecek';
    return;
  }
  
  state.selectedId = unitId;
  updateSelection();
}

function handleBuildingClick(buildingId) {
  const building = state.entities.get(buildingId);
  if (!building || building.team !== state.myTeam) return;
  
  state.selectedId = buildingId;
  updateSelection();
}

function handleMapClick(latlng) {
  if (state.selectedId) {
    const entity = state.entities.get(state.selectedId);
    
    if (entity instanceof Unit) {
      // Hareket komutu gÃ¶nder
      state.commandBuffer.push({
        type: 'MOVE',
        unitId: entity.id,
        target: { lat: latlng.lat, lng: latlng.lng }
      });
      
      addCombatLog(`${entity.stats.name} hedefe doÄŸru ilerliyor`);
      document.getElementById('hintText').textContent = 'âœ“ Hareket komutu verildi';
    }
  }
}

// ============================================
// SELECTION & RANGE DISPLAY
// ============================================
function updateSelection() {
  // TÃ¼m marker'larÄ± gÃ¼ncelle
  state.entities.forEach(entity => {
    if (entity.marker && entity.marker.getElement()) {
      const el = entity.marker.getElement().querySelector('.unit-marker, .building-marker');
      if (el) {
        if (state.selectedId === entity.id) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      }
    }
  });
  
  // Menzil halkasÄ±
  updateRangeCircle();
  
  // UI gÃ¼ncelle
  updateSelectedUnitsUI();
  updateProduceMenu();
}

function updateRangeCircle() {
  if (state.rangeCircle) {
    state.map.removeLayer(state.rangeCircle);
    state.rangeCircle = null;
  }
  
  if (state.selectedId) {
    const entity = state.entities.get(state.selectedId);
    
    if (entity instanceof Unit && entity.stats.range > 0) {
      const color = entity.team === 'p1' ? '#06b6d4' : '#ef4444';
      state.rangeCircle = L.circle([entity.lat, entity.lng], {
        radius: entity.stats.range,
        color: color,
        fillOpacity: 0.08,
        weight: 2,
        className: 'range-indicator'
      }).addTo(state.map);
    }
  }
}

function updateSelectedUnitsUI() {
  const container = document.getElementById('selectedUnitsInfo');
  
  if (!state.selectedId) {
    container.innerHTML = '<p class="text-slate-500">Birim seÃ§ilmedi</p>';
    return;
  }
  
  const entity = state.entities.get(state.selectedId);
  if (!entity) {
    container.innerHTML = '<p class="text-slate-500">Birim seÃ§ilmedi</p>';
    return;
  }
  
  const hpPercent = (entity.hp / entity.stats.hp * 100).toFixed(0);
  const hpColor = hpPercent > 60 ? 'text-green-400' : hpPercent > 30 ? 'text-yellow-400' : 'text-red-400';
  
  let rangeText = '';
  if (entity instanceof Unit && entity.stats.range > 0) {
    rangeText = `<div class="text-cyan-400">ğŸ“ Menzil: ${entity.stats.range}m</div>`;
  }
  
  container.innerHTML = `
    <div class="glass p-3 rounded-lg">
      <div class="text-2xl mb-2">${entity.stats.icon} ${entity.stats.name}</div>
      <div class="${hpColor} font-bold">â¤ï¸ SaÄŸlÄ±k: ${Math.round(entity.hp)}/${entity.stats.hp} (${hpPercent}%)</div>
      ${rangeText}
      ${entity instanceof Unit ? `<div class="text-slate-400">âš¡ DPS: ${entity.stats.dps}</div>` : ''}
    </div>
  `;
}

// ============================================
// BEAM EFFECT
// ============================================
function drawBeam(lat1, lng1, lat2, lng2) {
  if (!state.map) return;
  
  const color = '#ff6b00';
  const line = L.polyline([[lat1, lng1], [lat2, lng2]], {
    color: color,
    weight: 3,
    opacity: 1,
    className: 'beam-line'
  }).addTo(state.map);
  
  setTimeout(() => {
    state.map.removeLayer(line);
  }, 150);
}

// ============================================
// COMBAT LOG
// ============================================
function addCombatLog(message) {
  state.combatLog.unshift(message);
  if (state.combatLog.length > 30) state.combatLog.pop();
  
  const container = document.getElementById('combatLog');
  const entry = document.createElement('div');
  entry.className = 'combat-log-entry';
  entry.textContent = message;
  container.insertBefore(entry, container.firstChild);
  
  if (container.children.length > 30) {
    container.removeChild(container.lastChild);
  }
}

// ============================================
// VIEW MANAGEMENT
// ============================================
function showView(viewId) {
  ['A', 'B', 'C', 'D'].forEach(v => {
    const el = document.getElementById(`view${v}`);
    if (el) {
      el.classList.toggle('hidden', v !== viewId);
    }
  });
  state.currentView = viewId;
  
  if (viewId === 'D' && !state.mapReady) {
    setTimeout(initMap, 100);
  }
}

// ============================================
// FIREBASE AUTH
// ============================================
document.getElementById('loginBtn').addEventListener('click', async () => {
  try {
    const result = await auth.signInAnonymously();
    state.uid = result.user.uid;
    state.nick = document.getElementById('nickInput').value.trim() || `Commander${Math.floor(Math.random()*1000)}`;
    
    document.getElementById('userNickDisplay').textContent = state.nick;
    showView('B');
  } catch (err) {
    alert('GiriÅŸ hatasÄ±: ' + err.message);
  }
});

// ============================================
// ROOM MANAGEMENT
// ============================================
document.getElementById('createRoomBtn').addEventListener('click', async () => {
  const roomId = generateRoomId();
  const seed = Math.floor(Math.random() * 1000000);
  
  await db.ref(`rooms/${roomId}/meta`).set({
    createdAt: Date.now(),
    seed: seed,
    tickRate: NET_TICK_RATE,
    inputDelay: INPUT_DELAY,
    hostUid: state.uid
  });
  
  await db.ref(`rooms/${roomId}/players/${state.uid}`).set({
    nick: state.nick,
    side: 'p1',
    ready: false
  });
  
  await db.ref(`rooms/${roomId}/presence/${state.uid}`).set({
    online: true,
    lastSeen: Date.now()
  });
  
  db.ref(`rooms/${roomId}/presence/${state.uid}`).onDisconnect().update({
    online: false
  });
  
  state.roomId = roomId;
  state.isHost = true;
  state.myTeam = 'p1';
  
  joinRoomUI(roomId);
});

document.getElementById('joinRoomBtn').addEventListener('click', () => {
  document.getElementById('joinRoomPanel').classList.remove('hidden');
});

document.getElementById('joinRoomConfirmBtn').addEventListener('click', async () => {
  const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
  if (!roomId) return;
  
  const snapshot = await db.ref(`rooms/${roomId}/meta`).once('value');
  if (!snapshot.exists()) {
    alert('Oda bulunamadÄ±!');
    return;
  }
  
  const playersSnap = await db.ref(`rooms/${roomId}/players`).once('value');
  const players = playersSnap.val() || {};
  
  if (Object.keys(players).length >= 2) {
    alert('Oda dolu!');
    return;
  }
  
  const side = Object.keys(players).length === 0 ? 'p1' : 'p2';
  
  await db.ref(`rooms/${roomId}/players/${state.uid}`).set({
    nick: state.nick,
    side: side,
    ready: false
  });
  
  await db.ref(`rooms/${roomId}/presence/${state.uid}`).set({
    online: true,
    lastSeen: Date.now()
  });
  
  db.ref(`rooms/${roomId}/presence/${state.uid}`).onDisconnect().update({
    online: false
  });
  
  state.roomId = roomId;
  state.isHost = false;
  state.myTeam = side;
  
  joinRoomUI(roomId);
});

function joinRoomUI(roomId) {
  document.getElementById('roomIdDisplay').textContent = roomId;
  showView('C');
  
  db.ref(`rooms/${roomId}/players`).on('value', updatePlayersUI);
  
  db.ref(`rooms/${roomId}/meta`).on('value', (snap) => {
    const meta = snap.val();
    if (meta && meta.startedAt && !state.gameStarted) {
      startGame(meta);
    }
  });
}

function updatePlayersUI(snapshot) {
  const players = snapshot.val() || {};
  const container = document.getElementById('playersListInRoom');
  container.innerHTML = '';
  
  let allReady = true;
  let count = 0;
  
  Object.entries(players).forEach(([uid, data]) => {
    count++;
    const div = document.createElement('div');
    div.className = 'glass-bright p-4 rounded-xl';
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <span class="font-bold text-xl text-cyan-300">${data.nick}</span>
          <span class="text-sm text-slate-400 ml-3">${data.side === 'p1' ? 'ğŸ”µ Mavi' : 'ğŸ”´ KÄ±rmÄ±zÄ±'}</span>
        </div>
        <div class="text-lg font-bold ${data.ready ? 'text-green-400' : 'text-yellow-400'}">
          ${data.ready ? 'âœ“ HAZIR' : 'â³ BEKLÄ°YOR'}
        </div>
      </div>
    `;
    container.appendChild(div);
    
    if (!data.ready) allReady = false;
  });
  
  if (state.isHost && count >= 2 && allReady) {
    document.getElementById('startGameBtn').classList.remove('hidden');
  } else {
    document.getElementById('startGameBtn').classList.add('hidden');
  }
}

document.getElementById('readyToggleBtn').addEventListener('click', async () => {
  const ref = db.ref(`rooms/${state.roomId}/players/${state.uid}/ready`);
  const snapshot = await ref.once('value');
  const currentReady = snapshot.val() || false;
  await ref.set(!currentReady);
  
  document.getElementById('readyToggleBtn').textContent = !currentReady ? 'âœ“ HAZIR' : 'â³ HAZIR DEÄÄ°L';
});

document.getElementById('startGameBtn').addEventListener('click', async () => {
  await db.ref(`rooms/${state.roomId}/meta/startedAt`).set(Date.now());
});

document.getElementById('leaveRoomBtn').addEventListener('click', () => {
  leaveRoom();
  showView('B');
});

function leaveRoom() {
  if (state.roomId) {
    db.ref(`rooms/${state.roomId}/players/${state.uid}`).remove();
    db.ref(`rooms/${state.roomId}/presence/${state.uid}`).remove();
    db.ref(`rooms/${state.roomId}`).off();
  }
  state.roomId = null;
  state.isHost = false;
  state.gameStarted = false;
}

// ============================================
// GAME START
// ============================================
async function startGame(meta) {
  state.gameStarted = true;
  state.seed = meta.seed;
  state.rng = new SeededRandom(meta.seed);
  state.tick = 0;
  state.lastSimTime = Date.now();
  
  showView('D');
  
  await initEntities();
  
  db.ref(`rooms/${state.roomId}/approved`).on('child_added', (snap) => {
    const tick = parseInt(snap.key);
    const data = snap.val();
    if (data && data.merged) {
      applyCommands(tick, data.merged);
    }
  });
  
  state.simulationRunning = true;
  simulationLoop();
  requestAnimationFrame(renderLoop);
  
  addCombatLog('ğŸ–ï¸ OPERASYON BAÅLADI!');
}

async function initEntities() {
  // Rastgele baÅŸlangÄ±Ã§ pozisyonlarÄ±
  const baseLat = state.rng.range(35, 50);
  const baseLng = state.rng.range(20, 45);
  
  const p1Lat = baseLat + state.rng.range(-0.03, 0.03);
  const p1Lng = baseLng + state.rng.range(-0.05, -0.02);
  
  const p2Lat = baseLat + state.rng.range(-0.03, 0.03);
  const p2Lng = baseLng + state.rng.range(0.02, 0.05);
  
  // P1
  createBuilding('HQ', 'p1', p1Lat, p1Lng);
  createBuilding('Barracks', 'p1', p1Lat + 0.004, p1Lng + 0.003);
  createBuilding('Bank', 'p1', p1Lat - 0.004, p1Lng + 0.003);
  
  for (let i = 0; i < 5; i++) {
    spawnUnit('Infantry', 'p1', p1Lat + state.rng.range(-0.003, 0.003), p1Lng + state.rng.range(-0.003, 0.003));
  }
  spawnUnit('Tank', 'p1', p1Lat - 0.005, p1Lng);
  spawnUnit('APC', 'p1', p1Lat - 0.006, p1Lng + 0.002);
  
  // P2
  createBuilding('HQ', 'p2', p2Lat, p2Lng);
  createBuilding('Barracks', 'p2', p2Lat + 0.004, p2Lng - 0.003);
  createBuilding('Bank', 'p2', p2Lat - 0.004, p2Lng - 0.003);
  
  for (let i = 0; i < 5; i++) {
    spawnUnit('Infantry', 'p2', p2Lat + state.rng.range(-0.003, 0.003), p2Lng + state.rng.range(-0.003, 0.003));
  }
  spawnUnit('Tank', 'p2', p2Lat - 0.005, p2Lng);
  spawnUnit('APC', 'p2', p2Lat - 0.006, p2Lng - 0.002);
  
  if (state.map) {
    state.map.setView([baseLat, baseLng], 13);
  }
}

// ============================================
// SIMULATION
// ============================================
function simulationLoop() {
  if (!state.simulationRunning) return;
  
  const now = Date.now();
  const elapsed = (now - state.lastSimTime) / 1000;
  
  if (elapsed >= NET_DT) {
    state.lastSimTime = now;
    state.tick++;
    
    simulate(NET_DT);
    
    if (state.commandBuffer.length > 0) {
      sendCommands(state.tick + INPUT_DELAY, state.commandBuffer);
      state.commandBuffer = [];
    }
    
    if (state.isHost) {
      hostMergeCommands(state.tick);
    }
  }
  
  setTimeout(simulationLoop, 10);
}

function simulate(dt) {
  state.entities.forEach(entity => {
    if (entity.update) {
      entity.update(dt);
    }
  });
  
  updateResourcesUI();
  updateProductionQueueUI();
}

function applyCommands(tick, commands) {
  commands.forEach(cmd => {
    try {
      if (cmd.type === 'MOVE') {
        const unit = state.entities.get(cmd.unitId);
        if (unit && unit instanceof Unit) {
          unit.targetPos = { lat: cmd.target.lat, lng: cmd.target.lng };
          unit.targetEnemy = null;
        }
      } else if (cmd.type === 'BUILD') {
        if (cmd.team === state.myTeam) {
          const cost = BUILDING_TYPES[cmd.buildingType]?.cost || {};
          if (canAfford(cost)) {
            deductResources(cost);
            createBuilding(cmd.buildingType, cmd.team, cmd.at.lat, cmd.at.lng);
          }
        }
      } else if (cmd.type === 'PRODUCE') {
        const building = state.entities.get(cmd.buildingId);
        if (building && building instanceof Building && building.team === state.myTeam) {
          const unitStats = UNIT_TYPES[cmd.unitType];
          if (unitStats && canAfford(unitStats.cost)) {
            deductResources(unitStats.cost);
            building.productionQueue.push({
              unitType: cmd.unitType,
              time: unitStats.buildTime,
              progress: 0
            });
          }
        }
      }
    } catch (err) {
      console.error('Command error:', err);
    }
  });
}

// ============================================
// NETWORK
// ============================================
async function sendCommands(targetTick, commands) {
  if (!state.roomId || !state.uid || targetTick <= state.tick) return;
  
  try {
    await db.ref(`rooms/${state.roomId}/commands/${targetTick}/${state.uid}`).set({
      cmds: commands,
      timestamp: Date.now()
    });
  } catch (err) {
    console.error('Send error:', err);
  }
}

async function hostMergeCommands(tick) {
  try {
    const snapshot = await db.ref(`rooms/${state.roomId}/commands/${tick}`).once('value');
    const data = snapshot.val();
    
    const merged = [];
    if (data) {
      Object.entries(data).forEach(([uid, cmdData]) => {
        if (cmdData.cmds && Array.isArray(cmdData.cmds)) {
          cmdData.cmds.forEach(cmd => merged.push(cmd));
        }
      });
    }
    
    await db.ref(`rooms/${state.roomId}/approved/${tick}`).set({ merged });
  } catch (err) {
    console.error('Merge error:', err);
  }
}

// ============================================
// RENDER
// ============================================
function renderLoop() {
  state.entities.forEach(entity => {
    if (entity.updateMarkerPosition) {
      entity.updateMarkerPosition();
    }
  });
  
  if (state.selectedId) {
    const entity = state.entities.get(state.selectedId);
    if (entity && state.rangeCircle) {
      state.rangeCircle.setLatLng([entity.lat, entity.lng]);
    }
  }
  
  requestAnimationFrame(renderLoop);
}

// ============================================
// MAP
// ============================================
function initMap() {
  if (state.mapReady) return;
  
  const map = L.map('map', {
    worldCopyJump: true,
    minZoom: 3,
    maxZoom: 18
  }).setView([41, 29], 6);
  
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri'
  }).addTo(map);
  
  state.map = map;
  state.mapReady = true;
  
  state.entities.forEach(entity => {
    if (entity.createMarker) {
      entity.createMarker();
    }
  });
  
  map.on('click', (e) => {
    handleMapClick(e.latlng);
  });
}

// ============================================
// ECONOMY
// ============================================
function canAfford(cost) {
  return Object.entries(cost).every(([res, val]) => (state.resources[res] || 0) >= val);
}

function deductResources(cost) {
  Object.entries(cost).forEach(([res, val]) => {
    state.resources[res] = (state.resources[res] || 0) - val;
  });
}

function updateResourcesUI() {
  document.getElementById('resMoney').textContent = Math.floor(state.resources.money);
  document.getElementById('resOil').textContent = Math.floor(state.resources.oil);
  document.getElementById('resIron').textContent = Math.floor(state.resources.iron);
  document.getElementById('resGold').textContent = Math.floor(state.resources.gold);
  document.getElementById('resPop').textContent = state.resources.pop;
  document.getElementById('resPopMax').textContent = state.resources.popMax;
}

// ============================================
// BUILD & PRODUCE MENUS
// ============================================
document.getElementById('toggleBuildBtn').addEventListener('click', () => {
  const menu = document.getElementById('buildMenu');
  menu.classList.toggle('hidden');
  
  if (!menu.classList.contains('hidden') && menu.children.length === 0) {
    Object.entries(BUILDING_TYPES).forEach(([type, stats]) => {
      if (type === 'HQ') return;
      
      const btn = document.createElement('button');
      btn.className = 'btn-neon w-full text-left py-2 px-3 text-sm';
      btn.innerHTML = `${stats.icon} ${stats.name}<br><span class="text-xs opacity-75">${formatCost(stats.cost)}</span>`;
      btn.addEventListener('click', () => startBuildMode(type));
      menu.appendChild(btn);
    });
  }
});

document.getElementById('toggleProduceBtn').addEventListener('click', () => {
  const menu = document.getElementById('produceMenu');
  menu.classList.toggle('hidden');
});

function updateProduceMenu() {
  const menu = document.getElementById('produceMenu');
  
  if (!state.selectedId) {
    menu.innerHTML = '<p class="text-sm text-slate-400 text-center">Bir bina seÃ§in</p>';
    return;
  }
  
  const entity = state.entities.get(state.selectedId);
  
  if (!(entity instanceof Building) || !entity.stats.produces) {
    menu.innerHTML = '<p class="text-sm text-slate-400 text-center">Bu bina Ã¼retim yapamaz</p>';
    return;
  }
  
  menu.innerHTML = '';
  entity.stats.produces.forEach(unitType => {
    const stats = UNIT_TYPES[unitType];
    const btn = document.createElement('button');
    btn.className = 'btn-neon btn-cyan w-full text-left py-2 px-3 text-sm';
    btn.innerHTML = `${stats.icon} ${stats.name}<br><span class="text-xs opacity-75">${formatCost(stats.cost)}</span>`;
    btn.addEventListener('click', () => {
      state.commandBuffer.push({
        type: 'PRODUCE',
        buildingId: entity.id,
        unitType: unitType,
        team: state.myTeam
      });
    });
    menu.appendChild(btn);
  });
}

function formatCost(cost) {
  const parts = [];
  if (cost.money) parts.push(`ğŸ’°${cost.money}`);
  if (cost.oil) parts.push(`ğŸ›¢ï¸${cost.oil}`);
  if (cost.iron) parts.push(`â›“ï¸${cost.iron}`);
  if (cost.gold) parts.push(`ğŸª™${cost.gold}`);
  return parts.join(' ');
}

function startBuildMode(buildingType) {
  document.getElementById('hintText').textContent = `ğŸ—ï¸ ${BUILDING_TYPES[buildingType].name} yerleÅŸtirilecek. Haritada konum seÃ§in.`;
  
  const handler = (e) => {
    state.commandBuffer.push({
      type: 'BUILD',
      buildingType: buildingType,
      at: { lat: e.latlng.lat, lng: e.latlng.lng },
      team: state.myTeam
    });
    
    state.map.off('click', handler);
    document.getElementById('hintText').textContent = 'âœ“ Ä°nÅŸaat komutu verildi!';
    setTimeout(() => {
      document.getElementById('hintText').textContent = 'ğŸ¯ Sol tÄ±k: SeÃ§ | Tekrar tÄ±k: Hareket | Birim otomatik saldÄ±rÄ±r';
    }, 2000);
  };
  
  state.map.once('click', handler);
}

function updateProductionQueueUI() {
  const container = document.getElementById('productionQueue');
  const queue = [];
  
  state.entities.forEach(entity => {
    if (entity instanceof Building && entity.team === state.myTeam && entity.productionQueue.length > 0) {
      entity.productionQueue.forEach(item => {
        const progress = Math.round((item.progress / item.time) * 100);
        queue.push(`${UNIT_TYPES[item.unitType].icon} ${UNIT_TYPES[item.unitType].name} - ${progress}%`);
      });
    }
  });
  
  if (queue.length === 0) {
    container.innerHTML = '<p class="text-slate-500">Kuyruk boÅŸ</p>';
  } else {
    container.innerHTML = queue.map(q => `<div class="glass p-2 rounded text-sm">${q}</div>`).join('');
  }
}

// ============================================
// GAME END
// ============================================
function endGame(winnerTeam) {
  state.simulationRunning = false;
  
  const isVictory = winnerTeam === state.myTeam;
  document.getElementById('resultTitle').textContent = isVictory ? 'ğŸ† ZAFER!' : 'ğŸ’€ YENÄ°LGÄ°';
  document.getElementById('resultText').textContent = isVictory 
    ? 'DÃ¼ÅŸman komuta merkezini imha ettiniz!'
    : 'Komuta merkeziniz dÃ¼ÅŸtÃ¼!';
  
  document.getElementById('resultModal').classList.remove('hidden');
}

document.getElementById('closeResultBtn').addEventListener('click', () => {
  document.getElementById('resultModal').classList.add('hidden');
  leaveRoom();
  showView('B');
});

// ============================================
// UI EVENTS
// ============================================
document.getElementById('helpBtn').addEventListener('click', () => {
  document.getElementById('helpModal').classList.remove('hidden');
});

document.getElementById('closeHelpBtn').addEventListener('click', () => {
  document.getElementById('helpModal').classList.add('hidden');
});

document.getElementById('leaveGameBtn').addEventListener('click', () => {
  if (confirm('Operasyondan Ã§Ä±kmak istediÄŸinize emin misiniz?')) {
    state.simulationRunning = false;
    leaveRoom();
    showView('B');
  }
});

// ============================================
// UTILITIES
// ============================================
function generateRoomId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = '';
  for (let i = 0; i < 8; i++) {
    id += chars[Math.floor(Math.random() * chars.length)];
  }
  return id;
}

console.log('ğŸ–ï¸ Elite RTS baÅŸlatÄ±ldÄ±!');
</script>

</body>
</html>
