<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global RTS - Dünya Çapında Strateji</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { font-family: 'Montserrat', sans-serif; }
    body { margin: 0; padding: 0; overflow: hidden; background: #0a0e1a; }
    
    .glass {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: rgba(100, 116, 139, 0.5);
      color: white;
    }
    
    .btn-secondary:hover {
      background: rgba(100, 116, 139, 0.7);
    }
    
    .resource-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.4rem 0.8rem;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    #map { 
      width: 100%; 
      height: 100%; 
      background: #0a0e1a;
    }
    
    .unit-marker {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: 2px solid;
      transition: all 0.2s;
    }
    
    .unit-marker.selected {
      border-width: 3px;
      box-shadow: 0 0 12px currentColor;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .building-marker {
      width: 36px;
      height: 36px;
      border-radius: 0.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 2px solid;
      background: rgba(0, 0, 0, 0.5);
    }
    
    .hidden { display: none !important; }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(100, 116, 139, 0.8);
      border-radius: 3px;
    }
    
    .selection-box {
      position: absolute;
      border: 2px dashed #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

<!-- VIEW A: GİRİŞ -->
<div id="viewA" data-view="A" class="fixed inset-0 flex items-center justify-center">
  <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
    <h1 class="text-4xl font-bold text-center mb-2 text-white">🌍 Global RTS</h1>
    <p class="text-center text-slate-300 mb-6">Dünya çapında strateji savaşları</p>
    
    <input 
      id="nickInput" 
      type="text" 
      placeholder="Kullanıcı adı (opsiyonel)"
      class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 mb-4 focus:outline-none focus:border-blue-500"
    />
    
    <button id="loginBtn" class="btn btn-primary w-full">
      🔐 Anonim Giriş
    </button>
    
    <p class="text-xs text-slate-400 text-center mt-4">
      Firebase ile anonim kimlik doğrulama
    </p>
  </div>
</div>

<!-- VIEW B: LOBİ -->
<div id="viewB" data-view="B" class="hidden fixed inset-0 flex items-center justify-center">
  <div class="glass rounded-2xl p-8 max-w-2xl w-full mx-4">
    <h2 class="text-3xl font-bold text-white mb-6">🎮 Oyun Lobisi</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <button id="createRoomBtn" class="btn btn-primary text-lg py-4">
        ➕ Yeni Oda Kur
      </button>
      
      <button id="joinRoomBtn" class="btn btn-secondary text-lg py-4">
        🚪 Odaya Katıl
      </button>
    </div>
    
    <div id="joinRoomPanel" class="hidden">
      <input 
        id="roomIdInput" 
        type="text" 
        placeholder="Oda ID'sini girin"
        class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 mb-3 focus:outline-none focus:border-blue-500"
      />
      <button id="joinRoomConfirmBtn" class="btn btn-primary w-full">
        Katıl
      </button>
    </div>
    
    <p class="text-sm text-slate-400 text-center mt-4">
      Kullanıcı: <span id="userNickDisplay" class="text-blue-400 font-semibold"></span>
    </p>
  </div>
</div>

<!-- VIEW C: ODA -->
<div id="viewC" data-view="C" class="hidden fixed inset-0 flex items-center justify-center">
  <div class="glass rounded-2xl p-8 max-w-2xl w-full mx-4">
    <h2 class="text-3xl font-bold text-white mb-2">🏠 Oda</h2>
    <p class="text-slate-300 mb-6">
      Oda ID: <span id="roomIdDisplay" class="text-blue-400 font-mono font-bold"></span>
    </p>
    
    <div id="playersListInRoom" class="mb-6 space-y-3">
      <!-- Dinamik oyuncu listesi -->
    </div>
    
    <div class="flex gap-3">
      <button id="readyToggleBtn" class="btn btn-primary flex-1">
        ✓ Hazırım
      </button>
      
      <button id="startGameBtn" class="btn btn-primary flex-1 hidden">
        🚀 Oyunu Başlat
      </button>
      
      <button id="leaveRoomBtn" class="btn btn-secondary">
        ← Ayrıl
      </button>
    </div>
    
    <p class="text-xs text-slate-400 text-center mt-4">
      Her iki oyuncu da hazır olunca host oyunu başlatabilir
    </p>
  </div>
</div>

<!-- VIEW D: OYUN -->
<div id="viewD" data-view="D" class="hidden fixed inset-0 flex flex-col">
  <!-- ÜST BAR -->
  <div class="glass p-3 flex items-center justify-between gap-4 z-10">
    <div class="flex items-center gap-3 flex-wrap">
      <span class="resource-badge">💰 <span id="resMoney">300</span></span>
      <span class="resource-badge">🛢️ <span id="resOil">120</span></span>
      <span class="resource-badge">⛓️ <span id="resIron">120</span></span>
      <span class="resource-badge">🪙 <span id="resGold">10</span></span>
      <span class="resource-badge">🌾 <span id="resGrain">40</span></span>
      <span class="resource-badge">👥 <span id="resPop">0</span>/<span id="resPopMax">200</span></span>
    </div>
    
    <div class="flex items-center gap-2">
      <select id="speedControl" class="p-2 rounded bg-slate-700 text-white text-sm border border-slate-600">
        <option value="1">1x</option>
        <option value="5">5x</option>
        <option value="10">10x</option>
      </select>
      
      <button id="helpBtn" class="btn btn-secondary text-sm">❓</button>
      <button id="leaveGameBtn" class="btn btn-secondary text-sm">🚪 Ayrıl</button>
    </div>
  </div>
  
  <!-- ANA OYUN ALANI -->
  <div class="flex-1 flex relative overflow-hidden">
    <!-- SOL PANEL -->
    <div class="glass w-64 p-4 overflow-y-auto scrollbar-thin z-10">
      <h3 class="text-white font-bold mb-3">🏗️ İnşa & Üretim</h3>
      
      <button id="toggleBuildBtn" class="btn btn-primary w-full mb-3">
        İnşa Menüsü
      </button>
      
      <div id="buildMenu" class="hidden space-y-2 mb-4">
        <!-- Dinamik inşa menüsü -->
      </div>
      
      <button id="toggleProduceBtn" class="btn btn-primary w-full mb-3">
        Üretim (Seçili Bina)
      </button>
      
      <div id="produceMenu" class="hidden space-y-2 mb-4">
        <p class="text-xs text-slate-400 mb-2">Bir bina seçin</p>
      </div>
      
      <button id="wallModeBtn" class="btn btn-secondary w-full mb-2 text-sm">
        🧱 Duvar Çiz
      </button>
      
      <button id="gateModeBtn" class="btn btn-secondary w-full text-sm">
        🚧 Kapı Çiz
      </button>
    </div>
    
    <!-- HARİTA -->
    <div class="flex-1 relative">
      <div id="map"></div>
      <div id="selectionBox" class="selection-box hidden"></div>
    </div>
    
    <!-- SAĞ PANEL -->
    <div class="glass w-72 p-4 overflow-y-auto scrollbar-thin z-10">
      <h3 class="text-white font-bold mb-3">📊 Bilgi</h3>
      
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-300 mb-2">Seçili Birimler</h4>
        <div id="selectedUnitsInfo" class="text-xs text-slate-400">
          Hiçbir birim seçili değil
        </div>
      </div>
      
      <div class="mb-4">
        <h4 class="text-sm font-semibold text-slate-300 mb-2">Üretim Kuyruğu</h4>
        <div id="productionQueue" class="text-xs text-slate-400 space-y-1">
          Kuyruk boş
        </div>
      </div>
      
      <div>
        <h4 class="text-sm font-semibold text-slate-300 mb-2">⚔️ Savaş Günlüğü</h4>
        <div id="combatLog" class="text-xs text-slate-400 space-y-1 max-h-64 overflow-y-auto scrollbar-thin">
          Henüz olay yok
        </div>
      </div>
    </div>
  </div>
  
  <!-- ALT İPUCU -->
  <div class="glass p-2 text-center text-xs text-slate-300 z-10">
    <span id="hintText">Sol tık: seç | Sürükle: çoklu seçim | Sağ tık: hareket/saldır | H: yardım</span>
  </div>
</div>

<!-- YARDIM MODALI -->
<div id="helpModal" class="hidden modal-overlay">
  <div class="modal-content glass rounded-2xl p-6 text-white max-w-2xl">
    <h2 class="text-2xl font-bold mb-4">📖 Yardım & Kısayollar</h2>
    
    <div class="space-y-3 text-sm">
      <div><strong>Sol Tık:</strong> Birim/bina seçimi</div>
      <div><strong>Sol Sürükle:</strong> Çoklu seçim kutusu</div>
      <div><strong>Sağ Tık (boş):</strong> Seçili birimleri hareket ettir</div>
      <div><strong>Sağ Tık (düşman):</strong> Saldır</div>
      <div><strong>H:</strong> Bu yardım menüsü</div>
      <div><strong>K:</strong> Seçili kapıyı kilitle/aç</div>
      <div><strong>1/5/0:</strong> Oyun hızı (1x/5x/10x)</div>
    </div>
    
    <div class="mt-4 p-3 bg-slate-800 rounded">
      <p class="text-xs text-slate-300">
        <strong>Hedef:</strong> Düşman Merkez Üs'ünü (HQ) yok edin!
      </p>
    </div>
    
    <button id="closeHelpBtn" class="btn btn-primary w-full mt-4">Kapat</button>
  </div>
</div>

<!-- SONUÇ MODALI -->
<div id="resultModal" class="hidden modal-overlay">
  <div class="modal-content glass rounded-2xl p-8 text-center max-w-md">
    <h2 id="resultTitle" class="text-3xl font-bold mb-4">🏆</h2>
    <p id="resultText" class="text-lg text-slate-300 mb-6"></p>
    <button id="closeResultBtn" class="btn btn-primary w-full">Lobiye Dön</button>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<!-- Firebase JS SDK v9 (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script type="module">
// ===========================
// FİREBASE CONFIG & INIT
// ===========================
const firebaseConfig = {
  apiKey: "AIzaSyCV609XeHMtmZtD3FZDJ0cQnDiXke4YlUs",
  authDomain: "globalrts-ea3b4.firebaseapp.com",
  databaseURL: "https://globalrts-ea3b4-default-rtdb.firebaseio.com",
  projectId: "globalrts-ea3b4",
  storageBucket: "globalrts-ea3b4.firebasestorage.app",
  messagingSenderId: "404807030737",
  appId: "1:404807030737:web:2efecfef884db0b58632f0",
  measurementId: "G-Q5YKGP8EXR"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ===========================
// GLOBAL STATE
// ===========================
const state = {
  currentView: 'A',
  uid: null,
  nick: null,
  roomId: null,
  isHost: false,
  gameStarted: false,
  
  // Oyun state
  tick: 0,
  entities: new Map(), // id -> entity
  selectedIds: new Set(),
  myTeam: null, // 'p1' veya 'p2'
  
  // Kaynaklar
  resources: {
    money: 300,
    oil: 120,
    iron: 120,
    gold: 10,
    grain: 40,
    pop: 0,
    popMax: 200
  },
  
  // Üretim kuyruğu
  productionQueue: [],
  
  // Komut buffer
  commandBuffer: [],
  
  // Simülasyon
  lastSimTime: 0,
  simulationRunning: false,
  
  // Map
  map: null,
  mapReady: false,
  beamLayer: null,
  rangeCircle: null,
  
  // Seçim kutusu
  selectionStart: null,
  isSelecting: false,
  
  // Wall/Gate mode
  wallMode: false,
  gateMode: false,
  wallPoints: [],
  
  // Combat log
  combatLog: [],
  
  // RNG
  seed: 12345,
  rng: null
};

// ===========================
// SABITLER
// ===========================
const WORLD_SCALE = 100; // 1 px = 100 m
const TIME_SCALE = 1;
const NET_TICK_RATE = 10; // Hz
const NET_DT = 1 / NET_TICK_RATE; // 0.1 s
const INPUT_DELAY = 3; // ticks
const STATE_HASH_INTERVAL = 20; // her 20 tikte bir

// Ekonomi sabitleri
const INCOME_INTERVAL = 3; // seconds
const INCOME_TICKS = INCOME_INTERVAL * NET_TICK_RATE; // 30 ticks

// ===========================
// RNG (Deterministik)
// ===========================
class SeededRandom {
  constructor(seed) {
    this.seed = seed;
  }
  
  next() {
    this.seed = (this.seed * 9301 + 49297) % 233280;
    return this.seed / 233280;
  }
  
  range(min, max) {
    return min + this.next() * (max - min);
  }
  
  int(min, max) {
    return Math.floor(this.range(min, max + 1));
  }
}

// ===========================
// ENTİTY SYSTEM
// ===========================
class Entity {
  constructor(id, type, team, lat, lng) {
    this.id = id;
    this.type = type;
    this.team = team;
    this.lat = lat;
    this.lng = lng;
    this.marker = null;
  }
  
  destroy() {
    if (this.marker) {
      state.map.removeLayer(this.marker);
      this.marker = null;
    }
  }
}

class Unit extends Entity {
  constructor(id, type, team, lat, lng, stats) {
    super(id, type, team, lat, lng);
    this.stats = { ...stats };
    this.hp = stats.hp;
    this.target = null; // {lat, lng} veya targetId
    this.isMoving = false;
    this.cooldown = 0;
    this.cargo = []; // taşınan birimler
  }
  
  update(dt) {
    // Cooldown
    if (this.cooldown > 0) {
      this.cooldown -= dt;
    }
    
    // Hareket
    if (this.target && !this.target.id) {
      const dx = this.target.lng - this.lng;
      const dy = this.target.lat - this.lat;
      const dist = Math.sqrt(dx*dx + dy*dy);
      
      if (dist > 0.0001) {
        const speed = this.stats.speed / WORLD_SCALE * dt;
        const moveRatio = Math.min(1, speed / dist);
        
        this.lng += dx * moveRatio;
        this.lat += dy * moveRatio;
        this.isMoving = true;
      } else {
        this.isMoving = false;
        this.target = null;
      }
    }
    
    // Saldırı hedefi
    if (this.target && this.target.id) {
      const targetEntity = state.entities.get(this.target.id);
      if (targetEntity && targetEntity.team !== this.team) {
        const dx = targetEntity.lng - this.lng;
        const dy = targetEntity.lat - this.lat;
        const dist = Math.sqrt(dx*dx + dy*dy) * WORLD_SCALE;
        
        if (dist <= this.stats.range) {
          // Menzil içinde - ateş et
          if (this.cooldown <= 0 && this.stats.dps > 0) {
            const damage = this.stats.dps / this.stats.fireRate;
            targetEntity.hp -= damage;
            this.cooldown = 1 / this.stats.fireRate;
            
            // Beam efekti
            drawBeam(this.lat, this.lng, targetEntity.lat, targetEntity.lng);
            
            // Hedef öldüyse
            if (targetEntity.hp <= 0) {
              addCombatLog(`${this.type} bir ${targetEntity.type} yok etti!`);
              destroyEntity(targetEntity.id);
              this.target = null;
              
              // HQ kontrolü
              if (targetEntity.type === 'HQ') {
                endGame(this.team);
              }
            }
          }
        } else {
          // Menzil dışında - yaklaş
          const speed = this.stats.speed / WORLD_SCALE * dt;
          const moveRatio = Math.min(1, speed / dist * WORLD_SCALE);
          this.lng += dx * moveRatio;
          this.lat += dy * moveRatio;
          this.isMoving = true;
        }
      } else {
        this.target = null;
      }
    }
    
    // Otomatik hedef bulma (tehdit algısı)
    if (!this.target && this.stats.range > 0) {
      const threatRange = (this.stats.range + 50) / WORLD_SCALE;
      let closestEnemy = null;
      let closestDist = Infinity;
      
      state.entities.forEach(e => {
        if (e.team !== this.team && e.hp > 0) {
          const dx = e.lng - this.lng;
          const dy = e.lat - this.lat;
          const dist = Math.sqrt(dx*dx + dy*dy);
          
          if (dist < threatRange && dist < closestDist) {
            closestEnemy = e;
            closestDist = dist;
          }
        }
      });
      
      if (closestEnemy) {
        this.target = { id: closestEnemy.id };
      }
    }
  }
  
  createMarker() {
    const icon = L.divIcon({
      className: '',
      html: `<div class="unit-marker" style="background:${this.team === 'p1' ? '#3b82f6' : '#ef4444'}; border-color:${this.team === 'p1' ? '#60a5fa' : '#f87171'};">${getUnitIcon(this.type)}</div>`,
      iconSize: [24, 24]
    });
    
    this.marker = L.marker([this.lat, this.lng], { icon });
    this.marker.entityId = this.id;
    this.marker.addTo(state.map);
    
    // Click event
    this.marker.on('click', (e) => {
      L.DomEvent.stopPropagation(e);
      if (this.team === state.myTeam) {
        if (!e.originalEvent.shiftKey) {
          state.selectedIds.clear();
        }
        state.selectedIds.add(this.id);
        updateSelection();
      }
    });
  }
  
  updateMarkerPosition() {
    if (this.marker) {
      this.marker.setLatLng([this.lat, this.lng]);
      
      // HP bar güncelleme (opsiyonel - basit versiyon)
      const hpPercent = this.hp / this.stats.hp;
      if (hpPercent < 0.5) {
        this.marker.getElement().querySelector('.unit-marker').style.opacity = 0.5 + hpPercent;
      }
    }
  }
}

class Building extends Entity {
  constructor(id, type, team, lat, lng, stats) {
    super(id, type, team, lat, lng);
    this.stats = { ...stats };
    this.hp = stats.hp;
    this.productionQueue = [];
    this.constructionProgress = stats.buildTime ? 0 : 1;
    this.lastIncome = 0;
  }
  
  update(dt) {
    // İnşaat
    if (this.constructionProgress < 1) {
      this.constructionProgress += dt / this.stats.buildTime;
      if (this.constructionProgress >= 1) {
        this.constructionProgress = 1;
        addCombatLog(`${this.type} inşaatı tamamlandı!`);
      }
      return;
    }
    
    // Gelir üretimi
    if (this.stats.income && state.tick % INCOME_TICKS === 0) {
      if (this.team === state.myTeam) {
        Object.entries(this.stats.income).forEach(([res, val]) => {
          state.resources[res] = (state.resources[res] || 0) + val;
        });
      }
    }
    
    // Üretim
    if (this.productionQueue.length > 0) {
      const item = this.productionQueue[0];
      item.progress += dt;
      
      if (item.progress >= item.time) {
        this.productionQueue.shift();
        
        // Birim oluştur
        if (this.team === state.myTeam) {
          spawnUnit(item.unitType, this.team, this.lat + 0.001, this.lng + 0.001);
          addCombatLog(`${item.unitType} üretildi!`);
        }
      }
    }
  }
  
  createMarker() {
    const icon = L.divIcon({
      className: '',
      html: `<div class="building-marker" style="border-color:${this.team === 'p1' ? '#60a5fa' : '#f87171'};">${getBuildingIcon(this.type)}</div>`,
      iconSize: [36, 36]
    });
    
    this.marker = L.marker([this.lat, this.lng], { icon });
    this.marker.entityId = this.id;
    this.marker.addTo(state.map);
    
    this.marker.on('click', (e) => {
      L.DomEvent.stopPropagation(e);
      if (this.team === state.myTeam) {
        state.selectedIds.clear();
        state.selectedIds.add(this.id);
        updateSelection();
      }
    });
  }
  
  updateMarkerPosition() {
    // Binalar hareket etmez ama HP değişikliğini gösterebiliriz
    if (this.marker) {
      const hpPercent = this.hp / this.stats.hp;
      const el = this.marker.getElement();
      if (el) {
        const markerDiv = el.querySelector('.building-marker');
        if (hpPercent < 0.5) {
          markerDiv.style.opacity = 0.5 + hpPercent;
        }
      }
    }
  }
}

// ===========================
// DATA TABLES
// ===========================
const UNIT_TYPES = {
  Rifle: { hp: 60, speed: 2.0, range: 300, dps: 6, fireRate: 5, icon: '🪖', cost: { money: 30 }, buildTime: 5 },
  MG: { hp: 70, speed: 1.8, range: 400, dps: 10, fireRate: 10, icon: '⚔️', cost: { money: 50 }, buildTime: 6 },
  AT: { hp: 55, speed: 1.8, range: 700, dps: 30, fireRate: 0.5, icon: '🚀', cost: { money: 65, iron: 10 }, buildTime: 7 },
  AA: { hp: 55, speed: 1.8, range: 1000, dps: 25, fireRate: 0.4, icon: '🎯', cost: { money: 70, iron: 10 }, buildTime: 7 },
  APC: { hp: 220, speed: 12, range: 500, dps: 8, fireRate: 5, icon: '🚐', transportCapacity: 20, cost: { money: 120, oil: 40, iron: 40 }, buildTime: 10 },
  Tank: { hp: 420, speed: 14, range: 2000, dps: 45, fireRate: 0.3, icon: '🛡️', cost: { money: 220, oil: 80, iron: 120 }, buildTime: 15 },
  Artillery: { hp: 260, speed: 10, range: 4000, dps: 35, fireRate: 0.2, icon: '🎖️', cost: { money: 200, oil: 60, iron: 100 }, buildTime: 12 },
  MLRS: { hp: 240, speed: 10, range: 6000, dps: 28, fireRate: 0.15, icon: '💥', cost: { money: 240, oil: 80, iron: 120 }, buildTime: 14 },
  UAV: { hp: 120, speed: 25, range: 3000, dps: 12, fireRate: 1.2, icon: '✈️', cost: { money: 180, oil: 60 }, buildTime: 10 },
  Builder: { hp: 120, speed: 10, range: 0, dps: 0, icon: '🚜', cost: { money: 70, oil: 20 }, buildTime: 8 }
};

const BUILDING_TYPES = {
  HQ: { hp: 800, icon: '🏛️', produces: ['Rifle', 'Builder'], cost: { money: 0 }, buildTime: 0 },
  Mill: { hp: 400, icon: '🌾', income: { money: 3, grain: 4 }, cost: { money: 100 }, buildTime: 15 },
  Refinery: { hp: 400, icon: '🛢️', income: { oil: 2 }, cost: { money: 120 }, buildTime: 18 },
  IronMine: { hp: 450, icon: '⛓️', income: { iron: 2 }, cost: { money: 150 }, buildTime: 20 },
  GoldMine: { hp: 450, icon: '🪙', income: { gold: 1 }, cost: { money: 200 }, buildTime: 25 },
  Barracks: { hp: 500, icon: '🏰', produces: ['Rifle', 'MG', 'AT', 'AA'], cost: { money: 120 }, buildTime: 20 },
  Factory: { hp: 600, icon: '🏭', produces: ['APC', 'Tank'], cost: { money: 180, oil: 40, iron: 40 }, buildTime: 25 },
  Workshop: { hp: 550, icon: '🔧', produces: ['Artillery', 'MLRS'], cost: { money: 180, iron: 60 }, buildTime: 25 },
  Airfield: { hp: 500, icon: '🛫', produces: ['UAV'], cost: { money: 220, oil: 60 }, buildTime: 30 },
  Market: { hp: 350, icon: '🏪', incomeBonus: 0.2, cost: { money: 180 }, buildTime: 20 }
};

function getUnitIcon(type) {
  return UNIT_TYPES[type]?.icon || '❓';
}

function getBuildingIcon(type) {
  return BUILDING_TYPES[type]?.icon || '🏗️';
}

// ===========================
// VIEW YÖNETİMİ
// ===========================
function showView(viewId) {
  ['A', 'B', 'C', 'D'].forEach(v => {
    const el = document.getElementById(`view${v}`);
    if (el) {
      el.classList.toggle('hidden', v !== viewId);
    }
  });
  state.currentView = viewId;
  
  if (viewId === 'D' && !state.mapReady) {
    setTimeout(initMap, 100);
  }
}

// ===========================
// FİREBASE AUTH
// ===========================
document.getElementById('loginBtn').addEventListener('click', async () => {
  try {
    const result = await auth.signInAnonymously();
    state.uid = result.user.uid;
    state.nick = document.getElementById('nickInput').value.trim() || `Player${Math.floor(Math.random()*1000)}`;
    
    document.getElementById('userNickDisplay').textContent = state.nick;
    showView('B');
  } catch (err) {
    alert('Giriş hatası: ' + err.message);
  }
});

// ===========================
// ROOM YÖNETİMİ
// ===========================
document.getElementById('createRoomBtn').addEventListener('click', async () => {
  const roomId = generateRoomId();
  const seed = Math.floor(Math.random() * 1000000);
  
  await db.ref(`rooms/${roomId}/meta`).set({
    createdAt: Date.now(),
    seed: seed,
    tickRate: NET_TICK_RATE,
    inputDelay: INPUT_DELAY,
    hostUid: state.uid,
    stateEveryNTicks: STATE_HASH_INTERVAL
  });
  
  await db.ref(`rooms/${roomId}/players/${state.uid}`).set({
    nick: state.nick,
    side: 'p1',
    ready: false,
    lastAckTick: 0
  });
  
  await db.ref(`rooms/${roomId}/presence/${state.uid}`).set({
    online: true,
    lastSeen: Date.now()
  });
  
  db.ref(`rooms/${roomId}/presence/${state.uid}`).onDisconnect().update({
    online: false,
    lastSeen: Date.now()
  });
  
  state.roomId = roomId;
  state.isHost = true;
  state.myTeam = 'p1';
  
  joinRoomUI(roomId);
});

document.getElementById('joinRoomBtn').addEventListener('click', () => {
  document.getElementById('joinRoomPanel').classList.remove('hidden');
});

document.getElementById('joinRoomConfirmBtn').addEventListener('click', async () => {
  const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
  if (!roomId) return;
  
  const snapshot = await db.ref(`rooms/${roomId}/meta`).once('value');
  if (!snapshot.exists()) {
    alert('Oda bulunamadı!');
    return;
  }
  
  const playersSnap = await db.ref(`rooms/${roomId}/players`).once('value');
  const players = playersSnap.val() || {};
  
  if (Object.keys(players).length >= 2) {
    alert('Oda dolu!');
    return;
  }
  
  const side = Object.keys(players).length === 0 ? 'p1' : 'p2';
  
  await db.ref(`rooms/${roomId}/players/${state.uid}`).set({
    nick: state.nick,
    side: side,
    ready: false,
    lastAckTick: 0
  });
  
  await db.ref(`rooms/${roomId}/presence/${state.uid}`).set({
    online: true,
    lastSeen: Date.now()
  });
  
  db.ref(`rooms/${roomId}/presence/${state.uid}`).onDisconnect().update({
    online: false,
    lastSeen: Date.now()
  });
  
  state.roomId = roomId;
  state.isHost = false;
  state.myTeam = side;
  
  joinRoomUI(roomId);
});

function joinRoomUI(roomId) {
  document.getElementById('roomIdDisplay').textContent = roomId;
  showView('C');
  
  // Oyuncu listesini dinle
  db.ref(`rooms/${roomId}/players`).on('value', updatePlayersUI);
  
  // Meta dinle
  db.ref(`rooms/${roomId}/meta`).on('value', (snap) => {
    const meta = snap.val();
    if (meta && meta.startedAt && !state.gameStarted) {
      startGame(meta);
    }
  });
}

function updatePlayersUI(snapshot) {
  const players = snapshot.val() || {};
  const container = document.getElementById('playersListInRoom');
  container.innerHTML = '';
  
  let allReady = true;
  let count = 0;
  
  Object.entries(players).forEach(([uid, data]) => {
    count++;
    const div = document.createElement('div');
    div.className = 'glass p-3 rounded-lg';
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <span class="font-semibold text-white">${data.nick}</span>
          <span class="text-xs text-slate-400 ml-2">(${data.side})</span>
        </div>
        <div class="text-sm ${data.ready ? 'text-green-400' : 'text-yellow-400'}">
          ${data.ready ? '✓ Hazır' : '⏳ Bekliyor'}
        </div>
      </div>
    `;
    container.appendChild(div);
    
    if (!data.ready) allReady = false;
  });
  
  // Start butonu sadece host'ta ve iki oyuncu hazırsa göster
  if (state.isHost && count >= 2 && allReady) {
    document.getElementById('startGameBtn').classList.remove('hidden');
  } else {
    document.getElementById('startGameBtn').classList.add('hidden');
  }
}

document.getElementById('readyToggleBtn').addEventListener('click', async () => {
  const ref = db.ref(`rooms/${state.roomId}/players/${state.uid}/ready`);
  const snapshot = await ref.once('value');
  const currentReady = snapshot.val() || false;
  await ref.set(!currentReady);
  
  document.getElementById('readyToggleBtn').textContent = !currentReady ? '✓ Hazırım' : '⏳ Hazır Değilim';
});

document.getElementById('startGameBtn').addEventListener('click', async () => {
  await db.ref(`rooms/${state.roomId}/meta/startedAt`).set(Date.now());
});

document.getElementById('leaveRoomBtn').addEventListener('click', () => {
  leaveRoom();
  showView('B');
});

function leaveRoom() {
  if (state.roomId) {
    db.ref(`rooms/${state.roomId}/players/${state.uid}`).remove();
    db.ref(`rooms/${state.roomId}/presence/${state.uid}`).remove();
    db.ref(`rooms/${state.roomId}`).off();
  }
  state.roomId = null;
  state.isHost = false;
  state.gameStarted = false;
}

// ===========================
// OYUN BAŞLATMA
// ===========================
async function startGame(meta) {
  state.gameStarted = true;
  state.seed = meta.seed;
  state.rng = new SeededRandom(meta.seed);
  state.tick = 0;
  state.lastSimTime = Date.now();
  
  showView('D');
  
  // Başlangıç varlıklarını oluştur
  await initEntities();
  
  // Komut akışını dinle
  db.ref(`rooms/${state.roomId}/approved`).on('child_added', (snap) => {
    const tick = parseInt(snap.key);
    const data = snap.val();
    if (data && data.merged) {
      applyCommands(tick, data.merged);
    }
  });
  
  // Simülasyon başlat
  state.simulationRunning = true;
  simulationLoop();
  
  // Render loop
  requestAnimationFrame(renderLoop);
}

async function initEntities() {
  // Haritada rastgele başlangıç pozisyonları
  const centerLat = state.rng.range(40, 45);
  const centerLng = state.rng.range(30, 40);
  
  const p1Lat = centerLat + state.rng.range(-0.02, 0.02);
  const p1Lng = centerLng + state.rng.range(-0.02, 0.02);
  
  const p2Lat = centerLat + state.rng.range(-0.02, 0.02);
  const p2Lng = centerLng + state.rng.range(0.05, 0.10);
  
  // P1 başlangıç
  createBuilding('HQ', 'p1', p1Lat, p1Lng);
  createBuilding('Barracks', 'p1', p1Lat + 0.005, p1Lng);
  createBuilding('Mill', 'p1', p1Lat, p1Lng + 0.005);
  
  spawnUnit('Builder', 'p1', p1Lat - 0.002, p1Lng);
  for (let i = 0; i < 6; i++) {
    spawnUnit('Rifle', 'p1', p1Lat + state.rng.range(-0.003, 0.003), p1Lng + state.rng.range(-0.003, 0.003));
  }
  spawnUnit('APC', 'p1', p1Lat - 0.004, p1Lng + 0.002);
  spawnUnit('Tank', 'p1', p1Lat - 0.006, p1Lng);
  
  // P2 başlangıç
  createBuilding('HQ', 'p2', p2Lat, p2Lng);
  createBuilding('Barracks', 'p2', p2Lat + 0.005, p2Lng);
  createBuilding('Mill', 'p2', p2Lat, p2Lng + 0.005);
  
  spawnUnit('Builder', 'p2', p2Lat - 0.002, p2Lng);
  for (let i = 0; i < 6; i++) {
    spawnUnit('Rifle', 'p2', p2Lat + state.rng.range(-0.003, 0.003), p2Lng + state.rng.range(-0.003, 0.003));
  }
  spawnUnit('APC', 'p2', p2Lat - 0.004, p2Lng + 0.002);
  spawnUnit('Tank', 'p2', p2Lat - 0.006, p2Lng);
  
  // Haritayı merkeze sabitle
  if (state.map) {
    state.map.setView([centerLat, centerLng], 13);
  }
}

function createBuilding(type, team, lat, lng) {
  const id = `b_${Date.now()}_${Math.random()}`;
  const stats = BUILDING_TYPES[type];
  const building = new Building(id, type, team, lat, lng, stats);
  state.entities.set(id, building);
  
  if (state.mapReady) {
    building.createMarker();
  }
  
  return building;
}

function spawnUnit(type, team, lat, lng) {
  const id = `u_${Date.now()}_${Math.random()}`;
  const stats = UNIT_TYPES[type];
  const unit = new Unit(id, type, team, lat, lng, stats);
  state.entities.set(id, unit);
  
  if (state.mapReady) {
    unit.createMarker();
  }
  
  if (team === state.myTeam) {
    state.resources.pop = (state.resources.pop || 0) + 1;
  }
  
  return unit;
}

function destroyEntity(id) {
  const entity = state.entities.get(id);
  if (entity) {
    entity.destroy();
    state.entities.delete(id);
    state.selectedIds.delete(id);
    
    if (entity instanceof Unit && entity.team === state.myTeam) {
      state.resources.pop = Math.max(0, (state.resources.pop || 0) - 1);
    }
  }
}

// ===========================
// SİMÜLASYON DÖNGÜSÜ
// ===========================
function simulationLoop() {
  if (!state.simulationRunning) return;
  
  const now = Date.now();
  const elapsed = (now - state.lastSimTime) / 1000;
  
  if (elapsed >= NET_DT) {
    state.lastSimTime = now;
    state.tick++;
    
    // Simülasyonu güncelle
    simulate(NET_DT);
    
    // Komutları gönder (eğer buffer'da varsa)
    if (state.commandBuffer.length > 0) {
      sendCommands(state.tick + INPUT_DELAY, state.commandBuffer);
      state.commandBuffer = [];
    }
    
    // Host ise: bu tik için komutları birleştir
    if (state.isHost) {
      hostMergeCommands(state.tick);
    }
  }
  
  setTimeout(simulationLoop, 10);
}

function simulate(dt) {
  // Tüm entity'leri güncelle
  state.entities.forEach(entity => {
    if (entity.update) {
      entity.update(dt);
    }
  });
  
  // UI güncellemeleri
  updateResourcesUI();
  updateProductionQueueUI();
}

function applyCommands(tick, commands) {
  commands.forEach(cmd => {
    try {
      switch (cmd.type) {
        case 'MOVE':
          cmd.unitIds.forEach(id => {
            const unit = state.entities.get(id);
            if (unit && unit instanceof Unit) {
              unit.target = { lat: cmd.target.lat, lng: cmd.target.lng };
              unit.isMoving = true;
            }
          });
          break;
          
        case 'ATTACK':
          cmd.unitIds.forEach(id => {
            const unit = state.entities.get(id);
            if (unit && unit instanceof Unit) {
              unit.target = { id: cmd.targetId };
            }
          });
          break;
          
        case 'BUILD':
          if (cmd.team === state.myTeam) {
            const cost = BUILDING_TYPES[cmd.buildingType]?.cost || {};
            if (canAfford(cost)) {
              deductResources(cost);
              createBuilding(cmd.buildingType, cmd.team, cmd.at.lat, cmd.at.lng);
            }
          }
          break;
          
        case 'PRODUCE':
          const building = state.entities.get(cmd.buildingId);
          if (building && building instanceof Building && building.team === state.myTeam) {
            const unitStats = UNIT_TYPES[cmd.unitType];
            if (unitStats && canAfford(unitStats.cost)) {
              deductResources(unitStats.cost);
              building.productionQueue.push({
                unitType: cmd.unitType,
                time: unitStats.buildTime,
                progress: 0
              });
            }
          }
          break;
      }
    } catch (err) {
      console.error('Command apply error:', err);
    }
  });
}

// ===========================
// AĞ: KOMUT GÖNDERME
// ===========================
async function sendCommands(targetTick, commands) {
  if (!state.roomId || !state.uid) return;
  
  // Geçmişe yazma engeli
  if (targetTick <= state.tick) return;
  
  try {
    await db.ref(`rooms/${state.roomId}/commands/${targetTick}/${state.uid}`).set({
      cmds: commands,
      timestamp: Date.now()
    });
  } catch (err) {
    console.error('Send command error:', err);
  }
}

async function hostMergeCommands(tick) {
  try {
    const snapshot = await db.ref(`rooms/${state.roomId}/commands/${tick}`).once('value');
    const data = snapshot.val();
    
    if (!data) {
      // Komut yok, boş yaz
      await db.ref(`rooms/${state.roomId}/approved/${tick}`).set({ merged: [] });
      return;
    }
    
    // Tüm oyuncuların komutlarını birleştir
    const merged = [];
    Object.entries(data).forEach(([uid, cmdData]) => {
      if (cmdData.cmds && Array.isArray(cmdData.cmds)) {
        cmdData.cmds.forEach(cmd => {
          merged.push(cmd);
        });
      }
    });
    
    // Normalize (tekilleştir, vb.)
    const normalized = normalizeCommands(merged);
    
    await db.ref(`rooms/${state.roomId}/approved/${tick}`).set({ merged: normalized });
  } catch (err) {
    console.error('Host merge error:', err);
  }
}

function normalizeCommands(commands) {
  // Basit normalizasyon: aynı tick'te aynı birime birden fazla MOVE komutu varsa son olanı al
  const moveMap = new Map();
  const result = [];
  
  commands.forEach(cmd => {
    if (cmd.type === 'MOVE' && cmd.unitIds) {
      cmd.unitIds.forEach(id => {
        moveMap.set(id, cmd);
      });
    } else {
      result.push(cmd);
    }
  });
  
  // Move komutlarını ekle
  const uniqueMoves = new Map();
  moveMap.forEach((cmd, unitId) => {
    const key = `${cmd.target.lat},${cmd.target.lng}`;
    if (!uniqueMoves.has(key)) {
      uniqueMoves.set(key, { ...cmd, unitIds: [] });
    }
    uniqueMoves.get(key).unitIds.push(unitId);
  });
  
  uniqueMoves.forEach(cmd => result.push(cmd));
  
  return result;
}

// ===========================
// RENDER DÖNGÜSÜ
// ===========================
function renderLoop() {
  // Marker pozisyonlarını güncelle
  state.entities.forEach(entity => {
    if (entity.updateMarkerPosition) {
      entity.updateMarkerPosition();
    }
  });
  
  // Seçim halkaları
  updateRangeCircle();
  
  requestAnimationFrame(renderLoop);
}

// ===========================
// HARİTA KURULUMU
// ===========================
function initMap() {
  if (state.mapReady) return;
  
  const map = L.map('map', {
    worldCopyJump: true,
    minZoom: 2,
    maxZoom: 18
  }).setView([41, 35], 6);
  
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri'
  }).addTo(map);
  
  state.map = map;
  state.mapReady = true;
  
  // SVG overlay için beam layer
  const svg = L.svg();
  svg.addTo(map);
  state.beamLayer = d3.select(map.getPanes().overlayPane).select('svg').select('g');
  
  // Mevcut entity'lerin marker'larını oluştur
  state.entities.forEach(entity => {
    if (entity.createMarker) {
      entity.createMarker();
    }
  });
  
  // Map events
  map.on('click', onMapClick);
  map.on('contextmenu', onMapRightClick);
  map.on('mousedown', onMapMouseDown);
  map.on('mousemove', onMapMouseMove);
  map.on('mouseup', onMapMouseUp);
}

// ===========================
// SEÇİM & KOMUTLAR
// ===========================
function onMapClick(e) {
  if (state.wallMode || state.gateMode) {
    // Duvar/kapı noktası ekle
    state.wallPoints.push({ lat: e.latlng.lat, lng: e.latlng.lng });
    
    // İpucu
    document.getElementById('hintText').textContent = `Nokta ${state.wallPoints.length} eklendi. Çift tıkla bitir.`;
    return;
  }
  
  // Normal seçim
  if (!e.originalEvent.shiftKey) {
    state.selectedIds.clear();
  }
  updateSelection();
}

function onMapRightClick(e) {
  L.DomEvent.preventDefault(e);
  
  if (state.selectedIds.size === 0) return;
  
  // Hedef belirleme
  let targetEntity = null;
  state.entities.forEach(entity => {
    if (entity.marker) {
      const bounds = entity.marker.getLatLng();
      const dist = map.distance(e.latlng, bounds);
      if (dist < 50) { // 50m yakınlık
        targetEntity = entity;
      }
    }
  });
  
  const selectedUnits = Array.from(state.selectedIds)
    .map(id => state.entities.get(id))
    .filter(e => e instanceof Unit && e.team === state.myTeam);
  
  if (selectedUnits.length === 0) return;
  
  if (targetEntity && targetEntity.team !== state.myTeam) {
    // Saldır
    state.commandBuffer.push({
      type: 'ATTACK',
      unitIds: selectedUnits.map(u => u.id),
      targetId: targetEntity.id
    });
    
    addCombatLog(`${selectedUnits.length} birim saldırıya geçti!`);
  } else {
    // Hareket
    state.commandBuffer.push({
      type: 'MOVE',
      unitIds: selectedUnits.map(u => u.id),
      target: { lat: e.latlng.lat, lng: e.latlng.lng }
    });
  }
}

let selectionBoxStart = null;

function onMapMouseDown(e) {
  if (e.originalEvent.button === 0 && !state.wallMode && !state.gateMode) {
    selectionBoxStart = { x: e.originalEvent.clientX, y: e.originalEvent.clientY };
    state.isSelecting = true;
  }
}

function onMapMouseMove(e) {
  if (state.isSelecting && selectionBoxStart) {
    const box = document.getElementById('selectionBox');
    const x1 = Math.min(selectionBoxStart.x, e.originalEvent.clientX);
    const y1 = Math.min(selectionBoxStart.y, e.originalEvent.clientY);
    const x2 = Math.max(selectionBoxStart.x, e.originalEvent.clientX);
    const y2 = Math.max(selectionBoxStart.y, e.originalEvent.clientY);
    
    box.style.left = x1 + 'px';
    box.style.top = y1 + 'px';
    box.style.width = (x2 - x1) + 'px';
    box.style.height = (y2 - y1) + 'px';
    box.classList.remove('hidden');
  }
}

function onMapMouseUp(e) {
  if (state.isSelecting && selectionBoxStart) {
    const box = document.getElementById('selectionBox');
    box.classList.add('hidden');
    
    const x1 = Math.min(selectionBoxStart.x, e.originalEvent.clientX);
    const y1 = Math.min(selectionBoxStart.y, e.originalEvent.clientY);
    const x2 = Math.max(selectionBoxStart.x, e.originalEvent.clientX);
    const y2 = Math.max(selectionBoxStart.y, e.originalEvent.clientY);
    
    // Kutunun içindeki birimleri seç
    if (!e.originalEvent.shiftKey) {
      state.selectedIds.clear();
    }
    
    state.entities.forEach(entity => {
      if (entity instanceof Unit && entity.team === state.myTeam && entity.marker) {
        const point = state.map.latLngToContainerPoint(entity.marker.getLatLng());
        if (point.x >= x1 && point.x <= x2 && point.y >= y1 && point.y <= y2) {
          state.selectedIds.add(entity.id);
        }
      }
    });
    
    updateSelection();
    
    selectionBoxStart = null;
    state.isSelecting = false;
  }
}

function updateSelection() {
  // Marker'ları güncelle
  state.entities.forEach(entity => {
    if (entity.marker && entity.marker.getElement()) {
      const el = entity.marker.getElement().querySelector('.unit-marker, .building-marker');
      if (el) {
        if (state.selectedIds.has(entity.id)) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      }
    }
  });
  
  // UI güncelle
  updateSelectedUnitsUI();
  updateProduceMenu();
}

function updateSelectedUnitsUI() {
  const container = document.getElementById('selectedUnitsInfo');
  
  if (state.selectedIds.size === 0) {
    container.textContent = 'Hiçbir birim seçili değil';
    return;
  }
  
  const entities = Array.from(state.selectedIds).map(id => state.entities.get(id)).filter(Boolean);
  
  const html = entities.map(e => {
    const icon = e instanceof Unit ? getUnitIcon(e.type) : getBuildingIcon(e.type);
    const hp = Math.round(e.hp);
    const maxHp = e.stats.hp;
    return `<div>${icon} ${e.type} (${hp}/${maxHp} HP)</div>`;
  }).join('');
  
  container.innerHTML = html;
}

function updateRangeCircle() {
  if (state.rangeCircle) {
    state.map.removeLayer(state.rangeCircle);
    state.rangeCircle = null;
  }
  
  if (state.selectedIds.size === 1) {
    const id = Array.from(state.selectedIds)[0];
    const entity = state.entities.get(id);
    
    if (entity instanceof Unit && entity.stats.range > 0) {
      state.rangeCircle = L.circle([entity.lat, entity.lng], {
        radius: entity.stats.range,
        color: '#3b82f6',
        fillOpacity: 0.05,
        weight: 1
      }).addTo(state.map);
    }
  }
}

// ===========================
// BEAMefekti
// ===========================
function drawBeam(lat1, lng1, lat2, lng2) {
  if (!state.map || !state.beamLayer) return;
  
  const p1 = state.map.latLngToLayerPoint([lat1, lng1]);
  const p2 = state.map.latLngToLayerPoint([lat2, lng2]);
  
  const line = state.beamLayer.append('line')
    .attr('x1', p1.x)
    .attr('y1', p1.y)
    .attr('x2', p2.x)
    .attr('y2', p2.y)
    .attr('stroke', '#ff9100')
    .attr('stroke-width', 2)
    .attr('opacity', 0.9)
    .style('filter', 'drop-shadow(0 0 3px #ff9100)');
  
  // Fade out
  const duration = 120 + Math.random() * 60;
  setTimeout(() => {
    line.transition().duration(duration).attr('opacity', 0).remove();
  }, 10);
}

// ===========================
// EKONOMİ
// ===========================
function canAfford(cost) {
  return Object.entries(cost).every(([res, val]) => (state.resources[res] || 0) >= val);
}

function deductResources(cost) {
  Object.entries(cost).forEach(([res, val]) => {
    state.resources[res] = (state.resources[res] || 0) - val;
  });
}

function updateResourcesUI() {
  document.getElementById('resMoney').textContent = Math.floor(state.resources.money);
  document.getElementById('resOil').textContent = Math.floor(state.resources.oil);
  document.getElementById('resIron').textContent = Math.floor(state.resources.iron);
  document.getElementById('resGold').textContent = Math.floor(state.resources.gold);
  document.getElementById('resGrain').textContent = Math.floor(state.resources.grain);
  document.getElementById('resPop').textContent = state.resources.pop;
  document.getElementById('resPopMax').textContent = state.resources.popMax;
}

// ===========================
// İNŞA & ÜRETİM MENÜLERI
// ===========================
document.getElementById('toggleBuildBtn').addEventListener('click', () => {
  const menu = document.getElementById('buildMenu');
  menu.classList.toggle('hidden');
  
  if (!menu.classList.contains('hidden') && menu.children.length === 0) {
    // Dinamik menü oluştur
    Object.entries(BUILDING_TYPES).forEach(([type, stats]) => {
      if (type === 'HQ') return; // HQ inşa edilemez
      
      const btn = document.createElement('button');
      btn.className = 'btn btn-secondary w-full text-left text-sm';
      btn.innerHTML = `${stats.icon} ${type}<br><span class="text-xs opacity-75">${formatCost(stats.cost)}</span>`;
      btn.addEventListener('click', () => startBuildMode(type));
      menu.appendChild(btn);
    });
  }
});

document.getElementById('toggleProduceBtn').addEventListener('click', () => {
  const menu = document.getElementById('produceMenu');
  menu.classList.toggle('hidden');
});

function updateProduceMenu() {
  const menu = document.getElementById('produceMenu');
  
  if (state.selectedIds.size !== 1) {
    menu.innerHTML = '<p class="text-xs text-slate-400">Bir bina seçin</p>';
    return;
  }
  
  const id = Array.from(state.selectedIds)[0];
  const entity = state.entities.get(id);
  
  if (!(entity instanceof Building) || !entity.stats.produces) {
    menu.innerHTML = '<p class="text-xs text-slate-400">Bu bina üretim yapamaz</p>';
    return;
  }
  
  menu.innerHTML = '';
  entity.stats.produces.forEach(unitType => {
    const stats = UNIT_TYPES[unitType];
    const btn = document.createElement('button');
    btn.className = 'btn btn-secondary w-full text-left text-sm';
    btn.innerHTML = `${stats.icon} ${unitType}<br><span class="text-xs opacity-75">${formatCost(stats.cost)}</span>`;
    btn.addEventListener('click', () => {
      state.commandBuffer.push({
        type: 'PRODUCE',
        buildingId: entity.id,
        unitType: unitType,
        team: state.myTeam
      });
    });
    menu.appendChild(btn);
  });
}

function formatCost(cost) {
  const parts = [];
  if (cost.money) parts.push(`💰${cost.money}`);
  if (cost.oil) parts.push(`🛢️${cost.oil}`);
  if (cost.iron) parts.push(`⛓️${cost.iron}`);
  if (cost.gold) parts.push(`🪙${cost.gold}`);
  if (cost.grain) parts.push(`🌾${cost.grain}`);
  return parts.join(' ');
}

function startBuildMode(buildingType) {
  document.getElementById('hintText').textContent = `${buildingType} inşa edilecek. Haritada bir yer seçin.`;
  
  const handler = (e) => {
    state.commandBuffer.push({
      type: 'BUILD',
      buildingType: buildingType,
      at: { lat: e.latlng.lat, lng: e.latlng.lng },
      team: state.myTeam
    });
    
    state.map.off('click', handler);
    document.getElementById('hintText').textContent = 'İnşa komutu gönderildi!';
  };
  
  state.map.once('click', handler);
}

function updateProductionQueueUI() {
  const container = document.getElementById('productionQueue');
  const queue = [];
  
  state.entities.forEach(entity => {
    if (entity instanceof Building && entity.team === state.myTeam && entity.productionQueue.length > 0) {
      entity.productionQueue.forEach(item => {
        const progress = Math.round((item.progress / item.time) * 100);
        queue.push(`${getUnitIcon(item.unitType)} ${item.unitType} - ${progress}%`);
      });
    }
  });
  
  if (queue.length === 0) {
    container.textContent = 'Kuyruk boş';
  } else {
    container.innerHTML = queue.map(q => `<div>${q}</div>`).join('');
  }
}

// ===========================
// DUVAR/KAPI (Basit)
// ===========================
document.getElementById('wallModeBtn').addEventListener('click', () => {
  state.wallMode = !state.wallMode;
  state.gateMode = false;
  state.wallPoints = [];
  
  if (state.wallMode) {
    document.getElementById('hintText').textContent = 'Duvar çizimi: Noktaları tıklayın, çift tıkla bitirin.';
  } else {
    document.getElementById('hintText').textContent = 'Duvar modu iptal edildi.';
  }
});

document.getElementById('gateModeBtn').addEventListener('click', () => {
  state.gateMode = !state.gateMode;
  state.wallMode = false;
  state.wallPoints = [];
  
  if (state.gateMode) {
    document.getElementById('hintText').textContent = 'Kapı çizimi: İki nokta tıklayın.';
  } else {
    document.getElementById('hintText').textContent = 'Kapı modu iptal edildi.';
  }
});

// ===========================
// SAVAŞ GÜNLÜĞÜ
// ===========================
function addCombatLog(message) {
  state.combatLog.unshift(message);
  if (state.combatLog.length > 20) state.combatLog.pop();
  
  const container = document.getElementById('combatLog');
  const div = document.createElement('div');
  div.textContent = `• ${message}`;
  container.insertBefore(div, container.firstChild);
  
  if (container.children.length > 20) {
    container.removeChild(container.lastChild);
  }
}

// ===========================
// OYUN SONU
// ===========================
function endGame(winnerTeam) {
  state.simulationRunning = false;
  
  const isVictory = winnerTeam === state.myTeam;
  document.getElementById('resultTitle').textContent = isVictory ? '🏆 Zafer!' : '💀 Yenilgi';
  document.getElementById('resultText').textContent = isVictory 
    ? 'Düşman Merkez Üs\'ünü yok ettiniz!'
    : 'Merkez Üs\'ünüz yıkıldı!';
  
  document.getElementById('resultModal').classList.remove('hidden');
}

document.getElementById('closeResultBtn').addEventListener('click', () => {
  document.getElementById('resultModal').classList.add('hidden');
  leaveRoom();
  showView('B');
});

// ===========================
// YARDIM & DİĞER UI
// ===========================
document.getElementById('helpBtn').addEventListener('click', () => {
  document.getElementById('helpModal').classList.remove('hidden');
});

document.getElementById('closeHelpBtn').addEventListener('click', () => {
  document.getElementById('helpModal').classList.add('hidden');
});

document.getElementById('leaveGameBtn').addEventListener('click', () => {
  if (confirm('Oyundan çıkmak istediğinize emin misiniz?')) {
    state.simulationRunning = false;
    leaveRoom();
    showView('B');
  }
});

document.getElementById('speedControl').addEventListener('change', (e) => {
  // Hız kontrolü sadece görsel - simülasyon hızı sabit kalır
  // Bu basit versiyonda sadece animasyon hızını artırabiliriz (opsiyonel)
});

// Klavye kısayolları
document.addEventListener('keydown', (e) => {
  if (state.currentView !== 'D') return;
  
  switch(e.key.toLowerCase()) {
    case 'h':
      document.getElementById('helpBtn').click();
      break;
    case '1':
      document.getElementById('speedControl').value = '1';
      break;
    case '5':
      document.getElementById('speedControl').value = '5';
      break;
    case '0':
      document.getElementById('speedControl').value = '10';
      break;
  }
});

// ===========================
// YARDIMCI FONKSİYONLAR
// ===========================
function generateRoomId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id = '';
  for (let i = 0; i < 8; i++) {
    id += chars[Math.floor(Math.random() * chars.length)];
  }
  return id;
}

// D3.js CDN için
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js';
document.head.appendChild(script);

console.log('🌍 Global RTS başlatıldı!');
</script>

</body>
</html>
